<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="项目目标✔ 掌握通过原生语法开发小程序项目的思路。 ✔ 掌握项目公告、用户、房屋、报修、访客等管理模块的开发。">
<meta property="og:type" content="article">
<meta property="og:title" content="03_小程序享+项目">
<meta property="og:url" content="http://example.com/2023/02/21/xcx-course03/index.html">
<meta property="og:site_name" content="危险">
<meta property="og:description" content="项目目标✔ 掌握通过原生语法开发小程序项目的思路。 ✔ 掌握项目公告、用户、房屋、报修、访客等管理模块的开发。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/resource/images/wxacode.79d8452b.png">
<meta property="og:image" content="http://example.com/resource/images/picture_1.ddad61b2.jpg">
<meta property="og:image" content="http://example.com/resource/images/Snipaste_2023-03-03_16-09-30.png">
<meta property="og:image" content="http://example.com/resource/images/Snipaste_2023-03-04_09-07-41.png">
<meta property="article:published_time" content="2023-02-21T00:34:45.000Z">
<meta property="article:modified_time" content="2023-05-11T07:42:51.584Z">
<meta property="article:author" content="Ifer">
<meta property="article:tag" content="React,Redux,Mobx,Saga,Dva,Umi,AntD,TS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/resource/images/wxacode.79d8452b.png">

<link rel="canonical" href="http://example.com/2023/02/21/xcx-course03/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>03_小程序享+项目 | 危险</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">危险</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">为之则易，不为则难</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/21/xcx-course03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/49337922.png">
      <meta itemprop="name" content="Ifer">
      <meta itemprop="description" content="React 全家桶 <span style='position:relative;top:-2px;'>✍</span>">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="危险">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          03_小程序享+项目
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-21 08:34:45" itemprop="dateCreated datePublished" datetime="2023-02-21T08:34:45+08:00">2023-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-05-11 15:42:51" itemprop="dateModified" datetime="2023-05-11T15:42:51+08:00">2023-05-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="项目目标"><a href="#项目目标" class="headerlink" title="项目目标"></a>项目目标</h2><p>✔ 掌握通过原生语法开发小程序项目的思路。</p>
<p>✔ 掌握项目公告、用户、房屋、报修、访客等管理模块的开发。</p>
<span id="more"></span>

<h2 id="开发准备"><a href="#开发准备" class="headerlink" title="开发准备"></a>开发准备</h2><h3 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h3><p>享+社区是一个生活类的小程序项目，主要服务于小区业主，为其提供生活家电报修、访客门禁通行的的功能，该项目主要包含房屋管理、报修管理、访客管理、用户管理、通知管理等功能模块，技术栈以原生小程序技术为主配合了 Vant 组件库。</p>
<p><a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/doc-1492243">查看接口文档</a></p>
<p>扫码体验</p>
<img src="/resource/images/wxacode.79d8452b.png"/>

<h3 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h3><p>享+社区小程序项目静态页面已经完成，我们的任务是联调接口处理业务逻辑，以下是代码仓库地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitHub 仓库</span></span><br><span class="line"><span class="comment"># git clone -b template https://github.com/lotjol/enjoy-plus.git</span></span><br><span class="line"><span class="comment"># 或 gitee 仓库</span></span><br><span class="line">git <span class="built_in">clone</span> -b template https://gitee.com/lotjol/enjoy-plus.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改分支名称</span></span><br><span class="line">git branch -m template master</span><br></pre></td></tr></table></figure>

<h4 id="拉取代码"><a href="#拉取代码" class="headerlink" title="拉取代码"></a>拉取代码</h4><p>通过 git clone 拉取代码时默认会将远仓库地址指向了我的的仓库，会导致同学们 push 代码时失败，如果在企业中的情况下，需要联系负责人将你添加为团队开发者获取权限。</p>
<p>在课堂上老师就不一一添加大家成为开发者了，同学们自已建一个远程仓库，然后修改代码的远程仓库地址。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git remote add origin &#x27;这里是你的远程仓库地址&#x27;</span></span><br><span class="line">git remote set-url origin <span class="string">&#x27;这里是你的远程仓库地址&#x27;</span></span><br></pre></td></tr></table></figure>

<p>🤔 提示：在企业中做开发时不需要也不允许把代码放到个人仓库下的，切记切记！！！</p>
<h4 id="运行代码"><a href="#运行代码" class="headerlink" title="运行代码"></a>运行代码</h4><p>打开小程序开发者工具后选择导入小程序项目，然后导入刚刚拉取下来的代码，还要把 AppID 更换成同学位各自的。</p>
<p>🤔 提示：如果到企业里做开发时，这里的 AppID 要使用公司申请好的，然后联系团队负责人把你添加成为开发者。</p>
<img src="/resource/images/picture_1.ddad61b2.jpg"/>

<h4 id="熟悉环境"><a href="#熟悉环境" class="headerlink" title="熟悉环境"></a>熟悉环境</h4><p>安装项目的依赖，当前需要安装的依赖是 eslint 和 prettier 以及 Vant。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>重点注意的是 project.config.js 中的几个配置。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// #1 手动指定根目录</span></span><br><span class="line">    <span class="attr">&quot;miniprogramRoot&quot;</span>: <span class="string">&quot;miniprogram/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;setting&quot;</span>: &#123;</span><br><span class="line">        <span class="comment">// #2 支持 Sass</span></span><br><span class="line">        <span class="attr">&quot;useCompilerPlugins&quot;</span>: [<span class="string">&quot;sass&quot;</span>],</span><br><span class="line">        <span class="comment">// #3 开启手动构建 NPM 的路径</span></span><br><span class="line">        <span class="attr">&quot;packNpmManually&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;packNpmRelationList&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// #4 package.json 的位置</span></span><br><span class="line">                <span class="attr">&quot;packageJsonPath&quot;</span>: <span class="string">&quot;./package.json&quot;</span>,</span><br><span class="line">                <span class="comment">// #5 构建后的代码位置</span></span><br><span class="line">                <span class="attr">&quot;miniprogramNpmDistDir&quot;</span>: <span class="string">&quot;./miniprogram&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="VSCode"><a href="#VSCode" class="headerlink" title="VSCode"></a>VSCode</h4><p>VSCode 在编写代码方面比微信小程序更加方便，也更加符合大家的开发习惯，咱们在开发小程序时可以结合这两款工具，我们编写代码使用 VSCode，预览、调试、发布等使用小程序开发者工具。</p>
<p>在 VSCode 中无法原生支持 .wxml 文件的语法高亮及提示，需要安装一个插件: WXML - Language Service。</p>
<p>🤔 提示：完全使用小程序开发者工具也是没有问题的，只是结合 VSCode 编写代码会更方便一些。</p>
<h2 id="工具方法"><a href="#工具方法" class="headerlink" title="工具方法"></a>工具方法</h2><h3 id="消息反馈"><a href="#消息反馈" class="headerlink" title="消息反馈"></a>消息反馈</h3><p>在开发过程中需要向用户反馈消息的场景有很多，如检验接口调用的结果，表单验证的提示消息等，为此我们来对API <code>wx.showToast()</code> 进行简单的封装，方便开发中调用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建分支</span></span><br><span class="line">git checkout -b feat-utils</span><br></pre></td></tr></table></figure>

<h4 id="基础封装"><a href="#基础封装" class="headerlink" title="基础封装"></a>基础封装</h4><p>新建 <code>utils/utils.js</code> 文件，然后在这里完成具体的封装逻辑。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 工具方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> utils = &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 封装 wx.showToast</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 消息提示的内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">toast</span>(<span class="params">title = <span class="string">&#x27;数据加载失败...&#x27;</span></span>)</span> &#123;</span><br><span class="line">        wx.showToast(&#123;</span><br><span class="line">            title,</span><br><span class="line">            <span class="attr">mask</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展 wx 全局对象，切记不要与原用 api 重名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">wx.utils = utils</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模块化导出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> utils</span><br></pre></td></tr></table></figure>

<p>上述代码中将定义了一个对象 utils，在这个对象下可以扩展开发中经常用到的方法，然后将 utils 挂载到全局对象 wx 上，方便全局调用 uitls 中的方法。</p>
<p>🤔 提示：上述代码中 export default utils 的作用是除了通过 wx 全局可引用外，也可以当模块导入使用。</p>
<h4 id="局部加载"><a href="#局部加载" class="headerlink" title="局部加载"></a>局部加载</h4><p>在需要使用 utils 的场景下导入 <code>utils/utils</code> 模块， <code>miniprogram/pages/index/index.js</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 utils/utils 模块</span></span><br><span class="line"><span class="keyword">import</span> utils <span class="keyword">from</span> <span class="string">&#x27;../../utils/utils&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 不传参的方式</span></span><br><span class="line">        <span class="comment">// utils.toast()</span></span><br><span class="line">        <span class="comment">// 传入提示文字</span></span><br><span class="line">        <span class="comment">// utils.toast(&#x27;用户名只能用中文字符！&#x27;)</span></span><br><span class="line">        wx.utils.toast(<span class="string">&#x27;用户名只能用中文字符！&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="全局加载"><a href="#全局加载" class="headerlink" title="全局加载"></a>全局加载</h4><p>接下来在入口文件 <code>app.js</code> 中加载 <code>uitls/utils</code> 工具库。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载 utils/uitls.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./utils/utils&#x27;</span></span><br><span class="line">App(&#123;</span><br><span class="line">    <span class="attr">globalData</span>: &#123;&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>最后在页面中调用 <code>wx.utils.toast</code> 进行测试， <code>pages/index/index</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 不传参的方式</span></span><br><span class="line">        wx.utils.toast()</span><br><span class="line">        <span class="comment">// 传入提示文字</span></span><br><span class="line">        wx.utils.toast(<span class="string">&#x27;用户名只能中文字符！&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(utils): 封装工具方法&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h3><p>小程序中绝大部分的 API 都支持返回 Promise，也有几个 API 不支持返回 Promise，其中就包含 wx.request，开发中需要自行对 wx.request 进行封装也可以使用第三方的封装好的模块。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查有没有未提交的代码</span></span><br><span class="line">git status</span><br></pre></td></tr></table></figure>

<h4 id="安装-wechat-http"><a href="#安装-wechat-http" class="headerlink" title="安装 wechat-http"></a>安装 wechat-http</h4><p>本项目推荐使用咱们老师封装的一个 npm 模块 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/wechat-http">wechat-http</a>，我们先来安装，然后介绍它的使用方法。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># npm install wechat-http --registry=https://registry.npmjs.org</span></span><br><span class="line">npm install wechat-http</span><br></pre></td></tr></table></figure>

<p>🤔 提示：安装完毕后还要记得必须要构建后才可以使用 npm 的模块。</p>
<p>接下来介绍 wechat-http 模块的使用，其用法与 axios 类似。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 http 模块</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;wechat-http&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>http.baseURL 配置接口基础路径。</p>
</li>
<li><p>http.get 以 GET 方法发起请求。</p>
</li>
<li><p>http.post 以 POST 方法发起请求。</p>
</li>
<li><p>http.put 以 PUT 方法发起请求。</p>
</li>
<li><p>http.delete 以 DELETE 方法发起请求。</p>
</li>
<li><p>http.intercept 配置请求和响应拦截器。</p>
</li>
<li><p>http 本身做为函数调用也能用于发起网络请求。</p>
</li>
</ul>
<h4 id="公共配置"><a href="#公共配置" class="headerlink" title="公共配置"></a>公共配置</h4><p>新建 <code>utils/http.js</code> 文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 http 模块</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;wechat-http&#x27;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置接口基础路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.baseURL = <span class="string">&#x27;https://live-api.itheima.net&#x27;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 挂载方法到全局</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">wx.http = http</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模块导出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> http</span><br></pre></td></tr></table></figure>

<h4 id="全局加载-1"><a href="#全局加载-1" class="headerlink" title="全局加载"></a>全局加载</h4><p>项目启动入口 <code>app.js</code> 中加载 <code>utils/http.js</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载 utils/uitls.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./utils/utils&#x27;</span></span><br><span class="line"><span class="comment">// 加载 utils/http.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./utils/http&#x27;</span></span><br><span class="line"></span><br><span class="line">App(&#123;</span><br><span class="line">    <span class="attr">globalData</span>: &#123;&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在首页面来进行测试， <code>pages/index/index.js</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 测试网络请求</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> wx.http(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/announcement&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="built_in">console</span>.log(res)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>🤔 提示：不要忘了在小程序管理后台 request 合法域名列表中添加接口服务器域名喔。</p>
<h4 id="配置拦截器"><a href="#配置拦截器" class="headerlink" title="配置拦截器"></a>配置拦截器</h4><p>返回的数据中有一些冗余的数据，通过响应拦截器进行优化。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 http 模块</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;wechat-http&#x27;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接口基础路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.baseURL = <span class="string">&#x27;https://live-api.itheima.net&#x27;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置响应拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.intercept.response = <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 过滤接口返回的数据</span></span><br><span class="line">    <span class="keyword">return</span> res.data</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 挂载到wx全局对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">wx.http = http</span><br></pre></td></tr></table></figure>

<p>优化后调用接口时代码就会变更简洁。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/index/index</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 测试网络请求</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            data</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/announcement&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 接口返回数据</span></span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(utils): 配置网络请求&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到远程或合并到本地 main</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge feat-utils</span><br></pre></td></tr></table></figure>

<h2 id="公告管理"><a href="#公告管理" class="headerlink" title="公告管理"></a>公告管理</h2><h3 id="公告列表"><a href="#公告列表" class="headerlink" title="公告列表"></a>公告列表</h3><p>公告是由物业向业主发出的一系列的通知，它不需要检测用户的登录状态，因此直接调用后端数据接口获取数据，然后渲染出来就可以了。</p>
<img src="/resource/images/Snipaste_2023-03-03_16-09-30.png"/>

<h4 id="接口调用"><a href="#接口调用" class="headerlink" title="接口调用"></a>接口调用</h4><ul>
<li><p>接口路径：<code>/announcement</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41839039">见文档</a>。</p>
</li>
</ul>
<p> <code>miniprogram/pages/index/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #2 页面加载时调用接口获取数据</span></span><br><span class="line">        <span class="built_in">this</span>.getNotifyList()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// #1 定义方法请求数据接口</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getNotifyList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: notifyList</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/announcement&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 更新数据</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            notifyList</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="模板渲染"><a href="#模板渲染" class="headerlink" title="模板渲染"></a>模板渲染</h4><p>通过调试工具 AppData 中查看本地是否已经存在数据，然后再到模板中将数据渲染出来， <code>pages/index/index</code> 。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notices&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notices-head&quot;</span>&gt;</span>社区<span class="tag">&lt;<span class="name">text</span>&gt;</span>公告<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notices-body&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;notifyList&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">url</span>=<span class="string">&quot;&#123;&#123;&#x27;/pages/notify/index?id=&#x27; + item.id&#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;notice&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notice-title&quot;</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notice-brief&quot;</span>&gt;</span>&#123;&#123;item.content&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notice-date&quot;</span>&gt;</span>&#123;&#123;item.createdAt&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在对数据渲染时要注意，地址跳转拼凑上 id 参数，后续要根据这个参数获取公告的详情。</p>
<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查待提交的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(notify): 完成了公告列表&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="公告详情"><a href="#公告详情" class="headerlink" title="公告详情"></a>公告详情</h3><h4 id="接口调用-1"><a href="#接口调用-1" class="headerlink" title="接口调用"></a>接口调用</h4><ul>
<li><p>接口路径：<code>/announcement/:id</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无（参数拼凑在请求路径上）。</p>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42249556">见文档</a>。</p>
</li>
</ul>
<p> <code>pages/notify/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取地址上的 id 参数</span></span><br><span class="line">        <span class="comment">// console.log(id)</span></span><br><span class="line">        <span class="comment">// 3. 页面加载时调用方法获取数据</span></span><br><span class="line">        <span class="built_in">this</span>.getNotifyDetail(id)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 2. 定义请求数据接口的方法</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getNotifyDetail</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!id) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: notifyDetail</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/announcement/&#x27;</span> + id)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 更新数据</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            notifyDetail</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="模板渲染-1"><a href="#模板渲染-1" class="headerlink" title="模板渲染"></a>模板渲染</h4><p>通过调试工具 AppData 中查看本地是否已经存在数据，再到模板中将数据渲染出来。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notify-meta&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>&#123;&#123;notifyDetail.title&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;extra&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;author&quot;</span>&gt;</span>&#123;&#123;notifyDetail.creatorName&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;datetime&quot;</span>&gt;</span>&#123;&#123;notifyDetail.createdAt&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notify-content&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rich-text</span> <span class="attr">nodes</span>=<span class="string">&quot;社区定于8月3日中午喷洒灭蚊药...&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rich-text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="富文本处理"><a href="#富文本处理" class="headerlink" title="富文本处理"></a>富文本处理</h4><p>小程序中无法直接解析 html 的标签，然而一般的富文本编辑器生成的内容都是由 html 标签构成的，为了在小程序中解析富文件的内容，特别提供了 <code>rich-text</code> 组件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notify-meta&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>&#123;&#123;notifyDetail.title&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;extra&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;author&quot;</span>&gt;</span>&#123;&#123;notifyDetail.creatorName&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;datetime&quot;</span>&gt;</span>&#123;&#123;notifyDetail.createdAt&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;notify-content&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rich-text</span> <span class="attr">nodes</span>=<span class="string">&quot;&#123;&#123;notifyDetail.content&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">rich-text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查待提交的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(notify): 完成了公告详情&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到远程或合并到本地 main</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge feat-notify</span><br></pre></td></tr></table></figure>

<h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><h3 id="登录检测"><a href="#登录检测" class="headerlink" title="登录检测"></a>登录检测</h3><p>封装一些逻辑来检测用户是否是登录状态，如果不是则重定向到登录页，等用户完成登录后再跳转到用户本来要访问的页面。</p>
<p>我们通过本地存储的 token 来判断用户的登录状态，在小程序启动时读取本地存储并记录到应用实例当中，方便其它页面全局访问。</p>
<p> <code>app.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">App(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLaunch</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 读取 token</span></span><br><span class="line">        <span class="built_in">this</span>.getToken()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">getToken</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 异步方式不会阻塞</span></span><br><span class="line">        wx.getStorage(&#123;</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;token&#x27;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                data</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// this 指向应用实例</span></span><br><span class="line">                <span class="built_in">this</span>.token = data</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">fail</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">                <span class="comment">// 注意：没有 token 时，可能会触发这儿</span></span><br><span class="line">                <span class="built_in">console</span>.log(err)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>小程序中不支持路由拦截，需要开发者自行封装路由拦截的功能，实践有许多的实现思路，本项目采用封装组件的方式实现，主要的步骤如下。</p>
<ol>
<li>创建组件，<code>miniprogram/components/authorization</code> 并在 <code>app.json</code> 中全局注册。</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="attr">&quot;usingComponents&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;authorization&quot;</span>: <span class="string">&quot;/components/authorization/index&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在组件中添加插槽 slot，用户登录的情况下才显示插槽的内容，<code>components/authorization/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slot</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;isLogin&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在【房屋列表】页面应用 authorization 组件，<code>house_pkg/pages/list/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;true&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span> <span class="attr">class</span>=<span class="string">&quot;blank&quot;</span>&gt;</span></span><br><span class="line">        您还没有认证房屋，请点击 <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">class</span>=<span class="string">&quot;link&quot;</span> <span class="attr">url</span>=<span class="string">&quot; &quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此时跳转到【房屋列表】时会出现空白的内容，原因是 isLogin 的值当前为 undefined 即为 false 假值。</p>
<ol start="4">
<li>在生命周期函数 attached 中读取用户的登录状态，<code>components/authorization/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">isLogin</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 生命周期函数</span></span><br><span class="line">    <span class="attr">lifetimes</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">attached</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 登录状态</span></span><br><span class="line">            <span class="keyword">const</span> isLogin = !!getApp().token</span><br><span class="line">            <span class="comment">// 记录登录状态</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                isLogin</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 未登录重定向到登录页</span></span><br><span class="line">            <span class="keyword">if</span> (!isLogin) &#123;</span><br><span class="line">                <span class="comment">// 引导用户到登录页面</span></span><br><span class="line">                wx.redirectTo(&#123;</span><br><span class="line">                    <span class="attr">url</span>: <span class="string">`/pages/login/index`</span>,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>登录成功后回到原页面。</li>
</ol>
<p>在用户完成登录后，期望回到用户原本要访问的页面，要实现这个功能需要咱们先获取用户正在访问的页面路径，然后把这个路径传给登录页面，这样在登录成功后便可以再跳转到回这个页面了，获取页面路径的方法如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/authorization/index.js</span></span><br><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">isLogin</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 生命周期函数</span></span><br><span class="line">    <span class="attr">lifetimes</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">attached</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 登录状态</span></span><br><span class="line">            <span class="keyword">const</span> isLogin = !!getApp().token</span><br><span class="line">            <span class="comment">// 记录登录状态</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                isLogin</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 未登录重定向到登录页</span></span><br><span class="line">            <span class="keyword">if</span> (!isLogin) &#123;</span><br><span class="line">                <span class="comment">// 读取当前历史栈</span></span><br><span class="line">                <span class="keyword">const</span> pageStack = getCurrentPages()</span><br><span class="line">                <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">                <span class="keyword">const</span> currentPage = pageStack[pageStack.length - <span class="number">1</span>]</span><br><span class="line">                <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">                <span class="keyword">const</span> redirectURL = currentPage.route</span><br><span class="line">                <span class="comment">// 引导用户到登录页面</span></span><br><span class="line">                wx.redirectTo(&#123;</span><br><span class="line">                    <span class="attr">url</span>: <span class="string">`/pages/login/index?redirectURL=/<span class="subst">$&#123;redirectURL&#125;</span>`</span>,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h3><p>享+社区的登录和注册功能是合并在一起的，首先检测用户填写的手机号是否已经注册，如果未注册则会自动注册用户并登录，相反如果已注册用户则直接登录。</p>
<h4 id="倒计时功能"><a href="#倒计时功能" class="headerlink" title="倒计时功能"></a>倒计时功能</h4><ol>
<li>Vant 组件库中的 van-field 是一个输入框组件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #979797&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>van-field 组件支持插槽，插槽的内容我们放入一个倒计时组件 van-count-down。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">use-button-slot</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #979797&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 通过具名插槽 button 可以自定义输入框尾部的内容 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-slot&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-count-down</span> <span class="attr">time</span>=<span class="string">&quot;&#123;&#123; 60000 &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">van-count-down</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>van-count-down 组件的默认插槽，可以自定义倒计时内容的显示。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">use-button-slot</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #979797&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-slot&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-count-down</span> <span class="attr">use-slot</span> <span class="attr">time</span>=<span class="string">&quot;&#123;&#123; 60000 &#125;&#125;&quot;</span> <span class="attr">bind:change</span>=<span class="string">&quot;countDownChange&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123; timeData.seconds &#125;&#125;秒后重新获取<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-count-down</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>监听 van-count-down change 事件获取倒计时的时间变化信息。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// 获取倒计时信息</span></span><br><span class="line">    <span class="function"><span class="title">countDownChange</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">timeData</span>: ev.detail</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>倒计时结束时隐藏倒计时组件。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">countDownVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 获取倒计时信息</span></span><br><span class="line">    <span class="function"><span class="title">countDownChange</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">timeData</span>: ev.detail,</span><br><span class="line">            <span class="comment">// 倒计时出来的瞬间 ev.detail.minutes 为 1，seconds 为 0 </span></span><br><span class="line">            <span class="attr">countDownVisible</span>: ev.detail.minutes === <span class="number">1</span> || ev.detail.seconds &gt; <span class="number">0</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>视图中根据 countDownVisible 的状态，按需展示 <code>获取验证码按钮</code> 和 <code>倒计时</code> 的信息。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">use-button-slot</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #979797&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-slot&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;!countDownVisible&#125;&#125;&quot;</span>&gt;</span>获取验证码<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-count-down</span> <span class="attr">wx:else</span> <span class="attr">use-slot</span> <span class="attr">time</span>=<span class="string">&quot;&#123;&#123; 60000 &#125;&#125;&quot;</span> <span class="attr">bind:change</span>=<span class="string">&quot;countDownChange&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123; timeData.seconds &#125;&#125;秒后重新获取<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-count-down</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="获取验证码"><a href="#获取验证码" class="headerlink" title="获取验证码"></a>获取验证码</h4><p>用户填写手机号获取短信验证码验证用户的身份，我们分成 3 步来实现该功能。</p>
<ol>
<li>通过小程序的双向数据绑定获取表单的数据，<code>miniprogram/pages/login/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;mobile&#125;&#125;&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">use-button-slot</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #979797&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-slot&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;!countDownVisible&#125;&#125;&quot;</span>&gt;</span>获取验证码<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-count-down</span> <span class="attr">wx:else</span> <span class="attr">use-slot</span> <span class="attr">time</span>=<span class="string">&quot;&#123;&#123; 60000 &#125;&#125;&quot;</span> <span class="attr">bind:change</span>=<span class="string">&quot;countDownChange&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span>&gt;</span>&#123;&#123; timeData.seconds &#125;&#125;秒后重新获取<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-count-down</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-field</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li> 验证手机号码。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">mobile</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">countDownVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 倒计时</span></span><br><span class="line">    <span class="function"><span class="title">countDownChange</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证手机号格式</span></span><br><span class="line">    <span class="function"><span class="title">verifyMobile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 宽松的验证规则</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[1][3-8][0-9]&#123;9&#125;$/</span></span><br><span class="line">        <span class="comment">// 正则验证（去除两端空格）</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.mobile.trim())</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写正确的手机号码!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取短信验证码</span></span><br><span class="line">    <span class="function"><span class="title">getCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证手机号码格式是否正确</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调用接口。</li>
</ol>
<p>验证用户填写手机号码格式正确后请求后端接口获取短信验证码。</p>
<ul>
<li><p>接口路径：<code>/code</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>mobile 用户填写的手机号。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672274">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">mobile</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">countDownVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 倒计时</span></span><br><span class="line">    <span class="function"><span class="title">countDownChange</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证手机号格式</span></span><br><span class="line">    <span class="function"><span class="title">verifyMobile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 宽松的验证规则</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[1][3-8][0-9]&#123;9&#125;$/</span></span><br><span class="line">        <span class="comment">// 正则验证（去除两端空格）</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.mobile.trim())</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写正确的手机号码!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取短信验证码</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证手机号码格式是否正确</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/code&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">mobile</span>: <span class="built_in">this</span>.data.mobile.trim()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 验证接口返回结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.uitls.toast(<span class="string">&#x27;发送失败, 请稍后重试!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 发送验证码成功</span></span><br><span class="line">        wx.utils.toast(<span class="string">&#x27;发送成功, 请查收短信!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 开始倒计时</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">countDownVisible</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>后门测试。</li>
</ol>
<p>为了方便测试，咱们把短信验证码偷偷的保存在粘贴板中，顺便也多学习一个小程序的 API。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义变量保存验证码</span></span><br><span class="line"><span class="keyword">let</span> secret_code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">mobile</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">countDownVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 倒计时</span></span><br><span class="line">    <span class="function"><span class="title">countDownChange</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证手机号格式</span></span><br><span class="line">    <span class="function"><span class="title">verifyMobile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取短信验证码</span></span><br><span class="line">    <span class="function"><span class="title">getCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证手机号码格式是否正确</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            data</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/code&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">mobile</span>: <span class="built_in">this</span>.data.mobile.trim()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 验证接口返回结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.uitls.toast(<span class="string">&#x27;发送失败, 请稍后重试!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 发送验证码成功</span></span><br><span class="line">        wx.utils.toast(<span class="string">&#x27;发送成功, 请查收短信!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 开始倒计时</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">countDownVisible</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 记录验证码等待复制到粘贴板（仅用于测试环境）</span></span><br><span class="line">        secret_code = data.code</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 复制验证码到粘贴板</span></span><br><span class="line">    <span class="function"><span class="title">copyCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        wx.setClipboardData(&#123;</span><br><span class="line">            <span class="attr">data</span>: secret_code</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>🤔 提示：真实开发中接口并不会把短信验证码返回前端而是直接发送到用户的手机上，上述的做法只是用来学习。</p>
<h4 id="登录和注册"><a href="#登录和注册" class="headerlink" title="登录和注册"></a>登录和注册</h4><ol>
<li>获取验证码并进行验证。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;code&#125;&#125;&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入6位验证码&quot;</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #979797&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义变量保存验证码</span></span><br><span class="line"><span class="keyword">let</span> secret_code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">mobile</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">countDownVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 验证验证码</span></span><br><span class="line">    <span class="function"><span class="title">verifyCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证码为6位数字</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^\d&#123;6&#125;$/</span></span><br><span class="line">        <span class="comment">// 验证验证码</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.code.trim())</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请检查验证码是否正确!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 提交数据完成登录</span></span><br><span class="line">    <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyCode()) <span class="keyword">return</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/login</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>mobile 用户填写的手机号。</p>
</li>
<li><p>code 短信验证码。</p>
</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672276">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取应用实例</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 提交数据完成登录</span></span><br><span class="line">    <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #1 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyCode()) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// #2 解构用户填写的手机号和验证码</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line">        <span class="comment">// 调用接口登录/注册</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// #3 判错</span></span><br><span class="line">        <span class="keyword">if</span> (res.code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;请检查验证码是否正确!&#x27;</span>)</span><br><span class="line">        <span class="comment">// #4 拼凑完整 token </span></span><br><span class="line">        <span class="keyword">const</span> token = <span class="string">&#x27;Bearer &#x27;</span> + res.data.token</span><br><span class="line">        <span class="comment">// #5 本地存储 token</span></span><br><span class="line">        wx.setStorageSync(<span class="string">&#x27;token&#x27;</span>, token)</span><br><span class="line">        <span class="comment">// #6 更新全局 token</span></span><br><span class="line">        app.token = token</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>为了将来能够复用，咱们可以将存储 token 的逻辑封装到 <code>app.js</code> 中。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">App(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">setToken</span>(<span class="params">token</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 拼凑合法token格式</span></span><br><span class="line">        token = <span class="string">&#x27;Bearer &#x27;</span> + token</span><br><span class="line">        <span class="comment">// 本地存储 token 和 refresh_token</span></span><br><span class="line">        wx.setStorageSync(<span class="string">&#x27;token&#x27;</span>, token)</span><br><span class="line">        <span class="comment">// 更新全局 token 和 refresh_token</span></span><br><span class="line">        <span class="built_in">this</span>.token = token</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>然后调用封装好的方法来存储 token，代码也会变更简洁许多。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义变量保存验证码</span></span><br><span class="line"><span class="keyword">let</span> secret_code = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">// 获取应用实例</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 提交数据完成登录</span></span><br><span class="line">    <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #1 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyCode()) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// #2 用户填写的手机号和验证码</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// #3 校验数据是否合法</span></span><br><span class="line">        <span class="keyword">if</span> (res.code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;请检查验证码是否正确!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// #4 拼凑完整 token </span></span><br><span class="line">        <span class="comment">// #5 本地存储 token</span></span><br><span class="line">        <span class="comment">// #6 更新全局 token</span></span><br><span class="line">        app.setToken(res.data.token)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>重定向路由。</li>
</ol>
<p>还记得前面我们检测了用户的登录状态，未登录的情况会跳转到登录页面，同时将页面的路径作为参数传到了登录页面，现在我们来获取这个参数然后重定向到这个页面路径。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取应用实例</span></span><br><span class="line"><span class="keyword">const</span> app = getApp()</span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        redirectURL</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取地址参数</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            redirectURL</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 提交数据完成登录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyCode()) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户填写的手机号和验证码</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用接口登录/注册</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 校验数据是否合法</span></span><br><span class="line">        <span class="keyword">if</span> (res.code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;请检查验证码是否正确!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        app.setToken(res.data.token)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重定向至登录前的页面</span></span><br><span class="line">        wx.redirectTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="built_in">this</span>.data.redirectURL,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(user): 完成用户登录/注册功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="请求拦截器"><a href="#请求拦截器" class="headerlink" title="请求拦截器"></a>请求拦截器</h4><p>需要登录权限的接口必须将登录状态信息（token）发送给服务端，通过配置请求拦截器可以进行统一处理。</p>
<ol>
<li>基本用法，<code>utils/http.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置响应拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.intercept.request = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里必须要有返回</span></span><br><span class="line">    <span class="keyword">return</span> params</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试，<code>house_pkg/pages/list</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 目前该段代码只用于测试登录</span></span><br><span class="line">        wx.http.get(<span class="string">&#x27;/room&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在调用上述接口时并未成返回数据，原因在于虽然完成了登录的功能，但是当再次调用接口时未将登录的状态即 token 发给服务端。</p>
<ol start="2">
<li>设置头信息，<code>miniprogram/utils/http.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置响应拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.intercept.request = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 读取全局实例中的 token</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        token</span><br><span class="line">    &#125; = getApp()</span><br><span class="line">    <span class="comment">// 指定一个公共的头信息</span></span><br><span class="line">    <span class="comment">// 初始为空对象后续可以扩展</span></span><br><span class="line">    <span class="keyword">const</span> defaultHeader = &#123;&#125;</span><br><span class="line">    <span class="comment">// 追加 token 头信息</span></span><br><span class="line">    <span class="keyword">if</span> (token) defaultHeader.Authorization = token</span><br><span class="line">    <span class="comment">// 合并自定义头信息和公共头信息</span></span><br><span class="line">    params.header = <span class="built_in">Object</span>.assign(defaultHeader, params.header)</span><br><span class="line">    <span class="comment">// 处理后的请求参数</span></span><br><span class="line">    <span class="keyword">return</span> params</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中统一处理了 token 以头信息的方式传递给后接口，其中 defaultHeader 初始为一个空对象的目的是将来可以扩展更多的公共头信息，另外要注意调用 Object.assigin 时参数的顺序，我们希望的是用户指定的头信息能够覆盖掉默认的头信息。</p>
<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(user): 请求拦截器统一处理token&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="refresh-token"><a href="#refresh-token" class="headerlink" title="refresh_token"></a>refresh_token</h4><p>从安全角度来看 token 必须要具有一定的时效性，享+社区约定了 token 的时效为 8 个小时，失效后的 token 不再能标识用是登录状态。</p>
<p>另外也要考虑用户的体验，例如用户在 token 失效的前 1 分钟打开小程序，用户浏览小程序 1 分钟后 token 失效，用户不得不再次去登录，这样的用户体验是极差的。</p>
<p>为了既能保证安全性又兼顾用户体验，咱们需要能够自动延长 token 时效的方法，即 refresh_token，它的作工作制是这样的。</p>
<ul>
<li><p>用户在首次完成登录时会分别得到 token 和 refresh_token。</p>
</li>
<li><p>当 token 失效后，调用接口会返回 401 状态码（这是与后端约定好的规则）。</p>
</li>
<li><p>检测状态码是否为 401，如果是则调用延长 token 时效的接口并传递 refresh_token。</p>
</li>
<li><p>调用延长 token 时效的接口后会返回新的 token 和 refresh_token。</p>
</li>
</ul>
<ol>
<li>存储 refresh_token，<code>app.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">App(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onLaunch</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 读取 token 和 refresh_token</span></span><br><span class="line">        <span class="built_in">this</span>.getToken(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="built_in">this</span>.getToken(<span class="string">&#x27;refresh_token&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 读取token</span></span><br><span class="line">    <span class="function"><span class="title">getToken</span>(<span class="params">key</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 异步方式不会阻塞</span></span><br><span class="line">        wx.getStorage(&#123;</span><br><span class="line">            key,</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                data</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// this 指向应用实例</span></span><br><span class="line">                <span class="built_in">this</span>[key] = data</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">fail</span>(<span class="params"></span>)</span> &#123;&#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">setToken</span>(<span class="params">token, refresh_token</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 拼凑合法token格式</span></span><br><span class="line">        token = <span class="string">&#x27;Bearer &#x27;</span> + token</span><br><span class="line">        refresh_token = <span class="string">&#x27;Bearer &#x27;</span> + refresh_token</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 本地存储 token 和 refresh_token</span></span><br><span class="line">        wx.setStorageSync(<span class="string">&#x27;token&#x27;</span>, token)</span><br><span class="line">        wx.setStorageSync(<span class="string">&#x27;refresh_token&#x27;</span>, refresh_token)</span><br><span class="line">        <span class="comment">// 更新全局 token 和 refresh_token</span></span><br><span class="line">        <span class="built_in">this</span>.token = token</span><br><span class="line">        <span class="built_in">this</span>.refresh_token = refresh_token</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用 setToken 并传入 refresh_token，<code>pages/login/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// 之前代码省略...</span></span><br><span class="line">    <span class="comment">// 提交数据完成登录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyCode()) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 用户填写的手机号和验证码</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用接口登录/注册</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/login&#x27;</span>, &#123;</span><br><span class="line">            mobile,</span><br><span class="line">            code</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 校验数据是否合法</span></span><br><span class="line">        <span class="keyword">if</span> (res.code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;请检查验证码是否正确!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储记录token</span></span><br><span class="line">        app.setToken(res.data.token, res.data.refreshToken)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重定向至登录前的页面</span></span><br><span class="line">        wx.redirectTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="built_in">this</span>.data.redirectURL,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调用刷新 token 的接口。</li>
</ol>
<p>享+社区 token 的时效有 8 个小时，在开发调试阶段可以故意修改 token 的内容来主动让 token 失效。</p>
<ul>
<li><p>接口路径：<code>/refreshToken</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-44946311">见文档</a>。</p>
</li>
</ul>
<p> <code>utils/http.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">http.intercept.response = <span class="keyword">async</span> (&#123;</span><br><span class="line">    statusCode,</span><br><span class="line">    data</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// statusCode 为状态码</span></span><br><span class="line">    <span class="keyword">if</span> (statusCode === <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取全局应用实例</span></span><br><span class="line">        <span class="keyword">const</span> app = getApp()</span><br><span class="line">        <span class="comment">// 使用 refreshToken 更新 token</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> http(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/refreshToken&#x27;</span>,</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="comment">// 这时要注意使用的是 refresh_token</span></span><br><span class="line">                <span class="attr">Authorization</span>: app.refresh_token,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 更新 token 和 refresh_token</span></span><br><span class="line">        app.setToken(res.data.token, res.data.refreshToken)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤接口返回的数据</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>在调用刷新 token 接口时要注意头信息 header. Authorization 使用的是 refresh_token。</p>
<ol start="4">
<li>refresh_token 也过期了怎么办？</li>
</ol>
<p>用户长期未使用小程序的情况下 refresh_token 也会失效，享+社区设置的时间为 3天，如果 refresh_token 也失效的情况下需要重定向到登录页面。</p>
<p>再次手动修改 refresh_token 让它处于失效状态，然后调用接口后会出现列循环的情况（接口不断的请求），要解决这个问题需要判断当前是否调用的是 /refreshToken 接口，如果是且状态码返回的是 401 则重定页到登录页面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">http.intercept.response = <span class="keyword">async</span> (&#123;</span><br><span class="line">    statusCode,</span><br><span class="line">    data,</span><br><span class="line">    config</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// statusCode 为状态码</span></span><br><span class="line">    <span class="keyword">if</span> (statusCode === <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="comment">// config 是调用接口的参数</span></span><br><span class="line">        <span class="comment">// refreshToken 过期的情形</span></span><br><span class="line">        <span class="keyword">if</span> (config.url.includes(<span class="string">&#x27;/refreshToken&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 读取当前历史栈</span></span><br><span class="line">            <span class="keyword">const</span> pageStack = getCurrentPages()</span><br><span class="line">            <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">            <span class="keyword">const</span> lastPage = pageStack[pageStack.length - <span class="number">1</span>]</span><br><span class="line">            <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">            <span class="keyword">const</span> redirectURL = lastPage.route</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 引导用户到登录页面</span></span><br><span class="line">            <span class="keyword">return</span> wx.redirectTo(&#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">`/pages/login/index?redirectURL=/<span class="subst">$&#123;redirectURL&#125;</span>`</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取全局应用实例</span></span><br><span class="line">        <span class="keyword">const</span> app = getApp()</span><br><span class="line">        <span class="comment">// 使用 refreshToken 更新 token</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> http(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/refreshToken&#x27;</span>,</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="comment">// 这时要注意使用的是 refresh_token</span></span><br><span class="line">                <span class="attr">Authorization</span>: app.refresh_token,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新 token 和 refresh_token</span></span><br><span class="line">        app.setToken(res.data.token, res.data.refreshToken)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤接口返回的数据</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>当清空 token 和 refresh_token 后，跳转到登录页后控制到有个 401 的报错，可以屏蔽吗？<code>miniprogram/components/authorization/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// components/authorization/index.js</span></span><br><span class="line">Component(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">isLogin</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 生命周期函数</span></span><br><span class="line">    <span class="attr">lifetimes</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">attached</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 登录状态</span></span><br><span class="line">            <span class="keyword">const</span> isLogin = !!getApp().token</span><br><span class="line">            <span class="comment">// 记录登录状态</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                isLogin</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 未登录重定向到登录页</span></span><br><span class="line">            <span class="keyword">if</span> (!isLogin) &#123;</span><br><span class="line">                <span class="comment">// 读取当前历史栈</span></span><br><span class="line">                <span class="keyword">const</span> pageStack = getCurrentPages()</span><br><span class="line">                <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">                <span class="keyword">const</span> currentPage = pageStack[pageStack.length - <span class="number">1</span>]</span><br><span class="line">                <span class="comment">// 如果未登录将内部的逻辑置空，这样的话 network 就不会看到那个 401 报错啦</span></span><br><span class="line">                currentPage.onLoad = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">                currentPage.onShow = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">                <span class="keyword">const</span> redirectURL = currentPage.route</span><br><span class="line">                <span class="comment">// 引导用户到登录页面</span></span><br><span class="line">                wx.redirectTo(&#123;</span><br><span class="line">                    <span class="attr">url</span>: <span class="string">`/pages/login/index?redirectURL=/<span class="subst">$&#123;redirectURL&#125;</span>`</span>,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>无感请求。</li>
</ol>
<p>用户在请求某个接口时检测 token 失效，咱们去刷新了 token 当刷新成功后应该要继续去请求原来的接口，给用户的感知是一直处于登录状态的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置响应拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.intercept.response = <span class="keyword">async</span> (&#123;</span><br><span class="line">    data,</span><br><span class="line">    statusCode,</span><br><span class="line">    config</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (statusCode === <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> app = getApp()</span><br><span class="line">        <span class="keyword">if</span> (config.url.includes(<span class="string">&#x27;/refreshToken&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// app.clearTokenAndRefreshToken()</span></span><br><span class="line">            <span class="comment">// 读取当前历史栈</span></span><br><span class="line">            <span class="keyword">const</span> pageStack = getCurrentPages()</span><br><span class="line">            <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">            <span class="keyword">const</span> lastPage = pageStack[pageStack.length - <span class="number">1</span>]</span><br><span class="line">            <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">            <span class="keyword">const</span> redirectURL = lastPage.route</span><br><span class="line">            <span class="comment">// 引导用户到登录页面</span></span><br><span class="line">            <span class="keyword">return</span> wx.redirectTo(&#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">`/pages/login/index?redirectURL=/<span class="subst">$&#123;redirectURL&#125;</span>`</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> http(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/refreshToken&#x27;</span>,</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="attr">Authorization</span>: app.refresh_token</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        app.setToken(res.data.token, res.data.refreshToken)</span><br><span class="line">        <span class="comment">// 重新发起请求</span></span><br><span class="line">        <span class="keyword">return</span> http(</span><br><span class="line">            <span class="built_in">Object</span>.assign(config, &#123;</span><br><span class="line">                <span class="comment">// 传递新的 token</span></span><br><span class="line">                <span class="attr">header</span>: &#123;</span><br><span class="line">                    <span class="attr">Authorization</span>: app.token,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过滤接口返回的数据</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中 config 是用户原本要请求接口的参数，根据这些参数发起请求并传入刷新后的 token。</p>
<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(user): 完成refresh_token的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="个人资料"><a href="#个人资料" class="headerlink" title="个人资料"></a>个人资料</h3><p>享+社区的个人资料包括用户昵称和头像两个部分，关于昵称和头像的获取在前面基础知识部分已经介绍过了，咱们把这部分知识应用到实际的项目当中。</p>
<h4 id="用户昵称"><a href="#用户昵称" class="headerlink" title="用户昵称"></a>用户昵称</h4><img src="/resource/images/Snipaste_2023-03-04_09-07-41.png"/>

<ol>
<li>个人资料页面必须在用户登录的情况才允许被访问，需要使用前面封装好的 Authorization 组件将整个页面包起来，<code>pages/profile/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">center</span> <span class="attr">title</span>=<span class="string">&quot;头像&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-icon</span> <span class="attr">slot</span>=<span class="string">&quot;right-icon&quot;</span> <span class="attr">name</span>=<span class="string">&quot;arrow&quot;</span> <span class="attr">size</span>=<span class="string">&quot;16&quot;</span> <span class="attr">color</span>=<span class="string">&quot;#c3c3c5&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">size</span>=<span class="string">&quot;mini&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">open-type</span>=<span class="string">&quot;chooseAvatar&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/images/avatar_1.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">type</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">center</span> <span class="attr">label</span>=<span class="string">&quot;昵称&quot;</span> <span class="attr">input-align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入昵称&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>监听表单 van-field input 框的 blur 事件，获取输入的昵称。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">center</span> <span class="attr">title</span>=<span class="string">&quot;头像&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-icon</span> <span class="attr">slot</span>=<span class="string">&quot;right-icon&quot;</span> <span class="attr">name</span>=<span class="string">&quot;arrow&quot;</span> <span class="attr">size</span>=<span class="string">&quot;16&quot;</span> <span class="attr">color</span>=<span class="string">&quot;#c3c3c5&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">size</span>=<span class="string">&quot;mini&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">open-type</span>=<span class="string">&quot;chooseAvatar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/images/avatar_1.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">bind:blur</span>=<span class="string">&quot;getUserNickName&quot;</span> <span class="attr">type</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">center</span> <span class="attr">label</span>=<span class="string">&quot;昵称&quot;</span> <span class="attr">input-align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入昵称&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>🤔 提示：在开发者工具中，监听表单的 blur 事件获取用户昵称时会有不稳定的现象（不能立即获取表单中的值），发布到真机时问题会自动修复。</p>
<ol start="3">
<li>在事件回调中获取用户的昵称。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">getUserNickName</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户的昵称内容</span></span><br><span class="line">        <span class="built_in">console</span>.log(ev.detail.value)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>调用接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/userInfo</code>。</p>
</li>
<li><p>请求方法: PUT。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>nickName 用户昵称。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42037730">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">getUserNickName</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(ev.detail.value)</span></span><br><span class="line">        <span class="comment">// 更新用户昵称</span></span><br><span class="line">        <span class="built_in">this</span>.updateNickName(ev.detail.value)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">updateNickName</span>(<span class="params">nickName</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.put(<span class="string">&#x27;/userInfo&#x27;</span>, &#123;</span><br><span class="line">            nickName</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;更新用户信息失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存用户昵称</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="string">&#x27;userInfo.nickName&#x27;</span>: nickName</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>当用户未设置昵称时给用户指定一个默认的名称。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">center</span> <span class="attr">title</span>=<span class="string">&quot;头像&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-icon</span> <span class="attr">slot</span>=<span class="string">&quot;right-icon&quot;</span> <span class="attr">name</span>=<span class="string">&quot;arrow&quot;</span> <span class="attr">size</span>=<span class="string">&quot;16&quot;</span> <span class="attr">color</span>=<span class="string">&quot;#c3c3c5&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">size</span>=<span class="string">&quot;mini&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">open-type</span>=<span class="string">&quot;chooseAvatar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/images/avatar_1.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">bind:blur</span>=<span class="string">&quot;getUserNickName&quot;</span> <span class="attr">type</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;userInfo.nickName || &#x27;微信用户&#x27;&#125;&#125;&quot;</span> <span class="attr">center</span> <span class="attr">label</span>=<span class="string">&quot;昵称&quot;</span> <span class="attr">input-align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入昵称&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="用户头像"><a href="#用户头像" class="headerlink" title="用户头像"></a>用户头像</h4><ol>
<li>监听 button 的 chooseavatar 事件，获取头像地址。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">center</span> <span class="attr">title</span>=<span class="string">&quot;头像&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-icon</span> <span class="attr">slot</span>=<span class="string">&quot;right-icon&quot;</span> <span class="attr">name</span>=<span class="string">&quot;arrow&quot;</span> <span class="attr">size</span>=<span class="string">&quot;16&quot;</span> <span class="attr">color</span>=<span class="string">&quot;#c3c3c5&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">open-type</span>=<span class="string">&quot;chooseAvatar&quot;</span> <span class="attr">bind:chooseavatar</span>=<span class="string">&quot;getUserAvatar&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">size</span>=<span class="string">&quot;mini&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/images/avatar_1.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">bind:blur</span>=<span class="string">&quot;getUserNickName&quot;</span> <span class="attr">type</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;userInfo.nickName || &#x27;微信用户&#x27;&#125;&#125;&quot;</span> <span class="attr">center</span> <span class="attr">label</span>=<span class="string">&quot;昵称&quot;</span> <span class="attr">input-align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入昵称&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在事件回调函数 getUserAvatar 中获取用户头像地址。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">getUserNickName</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(ev.detail.value)</span></span><br><span class="line">        <span class="comment">// 更新用户昵称</span></span><br><span class="line">        <span class="built_in">this</span>.updateNickName(ev.detail.value)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">updateNickName</span>(<span class="params">nickName</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.put(<span class="string">&#x27;/userInfo&#x27;</span>, &#123;</span><br><span class="line">            nickName</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;更新用户信息失败!&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">getUserAvatar</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户头像地址</span></span><br><span class="line">        <span class="built_in">console</span>.log(ev.detail.avatarUrl)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调用接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/upload</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>file 后端接收上传文件的名称。</p>
</li>
<li><p>type 上传头像是传 avatar。</p>
</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672275">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">getUserAvatar</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户头像地址</span></span><br><span class="line">        <span class="comment">// console.log(ev.detail.avatarUrl)</span></span><br><span class="line">        <span class="built_in">this</span>.updateUserAvatar(ev.detail.avatarUrl)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">updateUserAvatar</span>(<span class="params">avatarUrl</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 调用接口上传图片</span></span><br><span class="line">        wx.uploadFile(&#123;</span><br><span class="line">            <span class="attr">url</span>: wx.http.baseURL + <span class="string">&#x27;/upload&#x27;</span>,</span><br><span class="line">            <span class="attr">filePath</span>: avatarUrl,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="attr">Authorization</span>: getApp().token,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// wx.uploadFile 规定除了文件信息，其他参数在 formData 里面传递</span></span><br><span class="line">            <span class="attr">formData</span>: &#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;avatar&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 转换 json 数据</span></span><br><span class="line">                <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(res.data)</span><br><span class="line">                <span class="comment">// 检测接口调用结果</span></span><br><span class="line">                <span class="keyword">if</span> (data.code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;更新头像失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保存并预览图片地址</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    <span class="string">&#x27;userInfo.avatar&#x27;</span>: data.data.url</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在页面上展示上传成功后的用户头像。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">center</span> <span class="attr">title</span>=<span class="string">&quot;头像&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-icon</span> <span class="attr">slot</span>=<span class="string">&quot;right-icon&quot;</span> <span class="attr">name</span>=<span class="string">&quot;arrow&quot;</span> <span class="attr">size</span>=<span class="string">&quot;16&quot;</span> <span class="attr">color</span>=<span class="string">&quot;#c3c3c5&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">open-type</span>=<span class="string">&quot;chooseAvatar&quot;</span> <span class="attr">bind:chooseavatar</span>=<span class="string">&quot;getUserAvatar&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span> <span class="attr">size</span>=<span class="string">&quot;mini&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;userInfo.avatar || &#x27;/static/images/avatar_1.jpg&#x27;&#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">bind:blur</span>=<span class="string">&quot;getUserNickName&quot;</span> <span class="attr">center</span> <span class="attr">label</span>=<span class="string">&quot;昵称&quot;</span> <span class="attr">input-align</span>=<span class="string">&quot;right&quot;</span> <span class="attr">type</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入昵称&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>🤔 提示： <code>wx.uploadFile()</code> 文件上传时需要在小程序管理后台添加接口对应的域名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(user): 完成用户昵称和头像填写功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="获取资料"><a href="#获取资料" class="headerlink" title="获取资料"></a>获取资料</h4><ol>
<li>调用接口。</li>
</ol>
<p>获取用户资料是指在我的 tabBar页面中调用接口获取用户的头像和昵称，上一小节我们已经为用户设置了昵称和头像，这一节只需要调用接口来获取这些数据即可。</p>
<ul>
<li><p>接口路径：<code>/userInfo</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42037729">见文档</a>。</p>
</li>
</ul>
<ol>
<li>封装获取用户信息的方法，并在 onShow 中调用，<code>miniprogram/pages/my/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取登录用户信息</span></span><br><span class="line">        <span class="built_in">this</span>.getUserInfo()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户信息接口</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getUserInfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: userInfo</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/userInfo&#x27;</span>)</span><br><span class="line">        <span class="comment">// 校验数据是否合法</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;数据加载失败, 请稍后重试!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 设置数据，更新渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            userInfo</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将接口请求来的数据渲染到页面当中，<code>miniprogram/pages/my/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile-base&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;userInfo.avatar || &#x27;/static/images/avatar_1.jpg&#x27;&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goLogin&quot;</span> <span class="attr">class</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>&#123;&#123;userInfo.nickName || &#x27;微信用户&#x27;&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">class</span>=<span class="string">&quot;link&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/pages/profile/index&quot;</span>&gt;</span></span><br><span class="line">            去完善信息<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-arrow&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;profile-extra&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">class</span>=<span class="string">&quot;item house&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/list/index&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span>&gt;</span>我的房屋<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">class</span>=<span class="string">&quot;item repair&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/repair_pkg/pages/list/index&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span>&gt;</span>我的报修<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">class</span>=<span class="string">&quot;item visitor&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/visitor_pkg/pages/list/index&quot;</span>&gt;</span>访客记录<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>tabBar 页面【我的】，在用户未登录的情况下进行调用接口会返回 401，此时由于是未登录的所以本地并没有 refresh_token，那么刷新 token 也自然就是没有必要的了，只需要在调用刷新 token 的接口时进行一个判断即可。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置响应拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.intercept.response = <span class="keyword">async</span> (&#123;</span><br><span class="line">    data,</span><br><span class="line">    statusCode,</span><br><span class="line">    config</span><br><span class="line">&#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (statusCode === <span class="number">401</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> app = getApp()</span><br><span class="line">        <span class="keyword">if</span> (config.url.includes(<span class="string">&#x27;/refreshToken&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// app.clearTokenAndRefreshToken()</span></span><br><span class="line">            <span class="comment">// 读取当前历史栈</span></span><br><span class="line">            <span class="keyword">const</span> pageStack = getCurrentPages()</span><br><span class="line">            <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">            <span class="keyword">const</span> lastPage = pageStack[pageStack.length - <span class="number">1</span>]</span><br><span class="line">            <span class="comment">// 取出当前页面路径，登录成功能跳转到该页面</span></span><br><span class="line">            <span class="keyword">const</span> redirectURL = lastPage.route</span><br><span class="line">            <span class="comment">// 引导用户到登录页面</span></span><br><span class="line">            <span class="keyword">return</span> wx.redirectTo(&#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">`/pages/login/index?redirectURL=/<span class="subst">$&#123;redirectURL&#125;</span>`</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// #mark</span></span><br><span class="line">        <span class="keyword">if</span> (!app.refresh_token) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> http(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/refreshToken&#x27;</span>,</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="attr">Authorization</span>: app.refresh_token</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        app.setToken(res.data.token, res.data.refreshToken)</span><br><span class="line">        <span class="comment">// 重新发起请求</span></span><br><span class="line">        <span class="keyword">return</span> http(</span><br><span class="line">            <span class="built_in">Object</span>.assign(config, &#123;</span><br><span class="line">                <span class="comment">// 传递新的 token</span></span><br><span class="line">                <span class="attr">header</span>: &#123;</span><br><span class="line">                    <span class="attr">Authorization</span>: app.token,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 过滤接口返回的数据</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>🤔 如果此时控制台有这个报错： <code>TypeError: Cannot read property &#39;code&#39; of undefined</code> ，可以在 <code>miniprogram/pages/my/index.js</code> 页面进行 try catch。</p>
<ol start="4">
<li>处理个人信息页面用户昵称和头像的默认值。</li>
</ol>
<p>思路：在【我的】页面获取到用户信息后，除了正常渲染外再把数据存储到本地，然后在个人资料页面直接进行读取。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/my/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取登录用户信息</span></span><br><span class="line">        <span class="built_in">this</span>.getUserInfo()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 用户信息接口</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getUserInfo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="comment">// 401 时，是没有 code 的</span></span><br><span class="line">        <span class="comment">// try catch 移除控制台错误</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123;</span><br><span class="line">                code,</span><br><span class="line">                <span class="attr">data</span>: userInfo</span><br><span class="line">            &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/userInfo&#x27;</span>)</span><br><span class="line">            <span class="comment">// 校验数据是否合法</span></span><br><span class="line">            <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;数据加载失败, 请稍后重试!&#x27;</span>)</span><br><span class="line">            <span class="comment">// 设置数据，更新渲染</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                userInfo</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 将用户信息存入本地</span></span><br><span class="line">            wx.setStorageSync(<span class="string">&#x27;userInfo&#x27;</span>, userInfo)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后再到个人资料页面进行读取， <code>pages/profile/index.js</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 从本地获取用户信息</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">userInfo</span>: wx.getStorageSync(<span class="string">&#x27;userInfo&#x27;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(user): 完成个资料的读取和完善&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="房屋管理"><a href="#房屋管理" class="headerlink" title="房屋管理"></a>房屋管理</h2><h3 id="添加房屋"><a href="#添加房屋" class="headerlink" title="添加房屋"></a>添加房屋</h3><p>添加房屋是为登录用户提供的一个创建房屋信息的功能，在添加了房屋的基础之上才能实现在线报修等功能。</p>
<h4 id="地理定位"><a href="#地理定位" class="headerlink" title="地理定位"></a>地理定位</h4><p>根据用户所在的位置定位到周围的小区或者根据用户指定的位置定位到周围小区，要实这个功能需要用到小程序的两个 API，分别如下。</p>
<ul>
<li><p>getLocation 获取用户所在位置的经纬度。</p>
</li>
<li><p>chooseLocation 用户指定位置的经纬度。</p>
</li>
</ul>
<p>注意：在小程序中调用这两个接口时必须要在 <code>app.json</code> 中申请调用权限。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;requiredPrivateInfos&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;getLocation&quot;</span>,</span><br><span class="line">        <span class="string">&quot;chooseLocation&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;permission&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;scope.userLocation&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;desc&quot;</span>: <span class="string">&quot;你的位置信息将用于小程序位置接口的效果展示&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>在页面加载时调用 <code>wx.getLocation()</code> 获取用户所在位置的经纬度，<code>house_pkg/pages/locate/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户所在位置周围小区</span></span><br><span class="line">        <span class="built_in">this</span>.getLocation()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.getLocation()</span><br><span class="line">        <span class="comment">// 查看经纬度</span></span><br><span class="line">        <span class="comment">// latitude =&gt; 纬度</span></span><br><span class="line">        <span class="built_in">console</span>.log(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>用户点击【重新定位】按钮时调用 <code>wx.chooseLocation()</code> 获取用户指定位置的经纬度。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/locate/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;locate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;当前地点&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-locate&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;chooseLocation&quot;</span>&gt;</span>重新定位<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;附近社区&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在事件回调函数 chooseLocation 中调用 API。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/locate/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户所在位置周围小区</span></span><br><span class="line">        <span class="built_in">this</span>.getLocation()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.getLocation()</span><br><span class="line">        <span class="comment">// 查看经纬度</span></span><br><span class="line">        <span class="built_in">console</span>.log(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">chooseLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.chooseLocation()</span><br><span class="line">        <span class="comment">// 注意点确定按钮的时候才会走这儿的打印</span></span><br><span class="line">        <span class="comment">// 查看经纬度</span></span><br><span class="line">        <span class="built_in">console</span>.log(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="腾讯位置"><a href="#腾讯位置" class="headerlink" title="腾讯位置"></a>腾讯位置</h4><p><a target="_blank" rel="noopener" href="https://lbs.qq.com/">https://lbs.qq.com/</a></p>
<p>腾讯位置服务为微信小程序提供了基础的标点能力、线和圆的绘制接口等地图组件和位置展示、地图选点等地图API位置服务能力支持，使得开发者可以自由地实现自己的微信小程序产品。 在此基础上，腾讯位置服务微信小程序 JavaScript SDK 是专为小程序开发者提供的LBS数据服务工具包，可以在小程序中调用腾讯位置服务的POI检索、关键词输入提示、地址解析、逆地址解析、行政区划和距离计算等数据服务，让您的小程序更强大！</p>
<p>提示：腾讯位置服务必须要注册账号申请密钥并且在小程序管理后台设置 request 合法域名: <a target="_blank" rel="noopener" href="https://apis.map.qq.com/">https://apis.map.qq.com</a> 后才可以使用。</p>
<p><a target="_blank" rel="noopener" href="https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview">微信小程序 JavaScript SDK</a></p>
<p>控制台 =&gt; 应用管理 =&gt; 我的应用 =&gt; 创建应用 =&gt; 添加 key =&gt; WebServiceAPI =&gt; 域名白名单。</p>
<!-- R3PBZ-EIALV-HYDP3-U7LWC-NNNJS-MAF4N7Q -->

<ol>
<li>逆地址解析。</li>
</ol>
<p>根据经纬度查询周围小区用到的是逆地址解析的功能，所谓的逆地址解析是指根据经纬度获取位置的相关描述，在申请完密钥后下载微信小程序 Javascript SDK 调用其提供的方法即可实现查询周围小区的功能。</p>
<p>下载并解压后将 JavaScript SDK 放到 libs 目录下，然后到 <code>utils/qqmap.js</code> 中配置腾讯位置服务的密钥。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> QQMapWX <span class="keyword">from</span> <span class="string">&#x27;../libs/qqmap-wx-jssdk.min&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户当前所在位置</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> QQMapWX(&#123;</span><br><span class="line">    <span class="comment">// 填写自已在腾讯地图创建应用的 key</span></span><br><span class="line">    <span class="attr">key</span>: <span class="string">&#x27;R3PBZ-EIALV-HYDP3-U7LWC-NNNJS-MAFN4Q7&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后再调用 SDK 提供的 reverseGeocoder 方法获取位置描述，<code>house_pkg/pages/locate/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入腾讯位置服务提供的 Javascript SDK</span></span><br><span class="line"><span class="keyword">import</span> qqMap <span class="keyword">from</span> <span class="string">&#x27;../../../utils/qqmap&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户所在位置周围小区</span></span><br><span class="line">        <span class="built_in">this</span>.getLocation()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.getLocation()</span><br><span class="line">        <span class="comment">// 调用 SDK 提共的方法</span></span><br><span class="line">        <span class="built_in">this</span>.getPoint(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">chooseLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.chooseLocation()</span><br><span class="line">        <span class="comment">// 注意点确定按钮的时候才会走这儿的打印</span></span><br><span class="line">        <span class="comment">// 调用 SDK 提共的方法</span></span><br><span class="line">        <span class="built_in">this</span>.getPoint(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">getPoint</span>(<span class="params">latitude, longitude</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 显示加载状态</span></span><br><span class="line">        wx.showLoading(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;正在加载...&#x27;</span>,</span><br><span class="line">            <span class="attr">mask</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 逆地址解析（根据经纬度查询位置相关描述）</span></span><br><span class="line">        qqMap.reverseGeocoder(&#123;</span><br><span class="line">            <span class="attr">location</span>: [latitude, longitude].join(<span class="string">&#x27;,&#x27;</span>),</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                result: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    address</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 结果为当前所在的地址</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    address</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将获取的位置描述展示到页面当中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/locate/index --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;locate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;当前地点&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;address&#125;&#125;&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">bind:tap</span>=<span class="string">&quot;chooseLocation&quot;</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-locate&quot;</span>&gt;</span>重新定位<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;附近社区&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;建材城西路9号&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>搜索附近的社区。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入腾讯位置服务提供的 JavaScript SDK</span></span><br><span class="line"><span class="keyword">import</span> qqMap <span class="keyword">from</span> <span class="string">&#x27;../../../utils/qqmap&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户所在位置周围小区</span></span><br><span class="line">        <span class="built_in">this</span>.getLocation()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.getLocation()</span><br><span class="line">        <span class="comment">// 调用 SDK 提共的方法</span></span><br><span class="line">        <span class="built_in">this</span>.getPoint(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">chooseLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 用户所在位置经纬度</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            latitude,</span><br><span class="line">            longitude</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.chooseLocation()</span><br><span class="line">        <span class="comment">// 注意点确定按钮的时候才会走这儿的打印</span></span><br><span class="line">        <span class="comment">// 调用 SDK 提共的方法</span></span><br><span class="line">        <span class="built_in">this</span>.getPoint(latitude, longitude)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">getPoint</span>(<span class="params">latitude, longitude</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 显示加载状态</span></span><br><span class="line">        wx.showLoading(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;正在加载...&#x27;</span>,</span><br><span class="line">            <span class="attr">mask</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 逆地址解析（根据经纬度查询位置相关信息）</span></span><br><span class="line">        qqMap.reverseGeocoder(&#123;</span><br><span class="line">            <span class="attr">location</span>: [latitude, longitude].join(<span class="string">&#x27;,&#x27;</span>),</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                result: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    address</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 更新数据，重新渲染</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    address</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 搜索周边</span></span><br><span class="line">        qqMap.search(&#123;</span><br><span class="line">            <span class="comment">// 搜索关键字（查询周边的小区）</span></span><br><span class="line">            <span class="attr">keyword</span>: <span class="string">&#x27;住宅小区&#x27;</span>,</span><br><span class="line">            <span class="comment">// 指定经纬度</span></span><br><span class="line">            <span class="attr">location</span>: [latitude, longitude].join(<span class="string">&#x27;,&#x27;</span>),</span><br><span class="line">            <span class="comment">// 查询数据条数</span></span><br><span class="line">            <span class="attr">page_size</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 处理得到的地点信息（过滤掉多余数据）</span></span><br><span class="line">                <span class="keyword">const</span> points = []</span><br><span class="line">                res.data.forEach(<span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    id,</span></span></span><br><span class="line"><span class="params"><span class="function">                    title,</span></span></span><br><span class="line"><span class="params"><span class="function">                    _distance</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">                    points.push(&#123;</span><br><span class="line">                        id,</span><br><span class="line">                        title,</span><br><span class="line">                        _distance</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新数据，重新渲染</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    points</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function"><span class="title">fail</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                wx.utils.toast(<span class="string">&#x27;没有找附近的小区!&#x27;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">complete</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 隐藏加载状态</span></span><br><span class="line">                wx.hideLoading()</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>将周边的社区渲染到页面当中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/locate/index --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;locate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;当前地点&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;address&#125;&#125;&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">bind:tap</span>=<span class="string">&quot;chooseLocation&quot;</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-locate&quot;</span>&gt;</span>重新定位<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;附近社区&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;points&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;item.title&#125;&#125;&quot;</span> <span class="attr">link-type</span>=<span class="string">&quot;navigateTo&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/building/index&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(house): 查询周边小区&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="选择楼栋"><a href="#选择楼栋" class="headerlink" title="选择楼栋"></a>选择楼栋</h4><p>在用户确定了某个小区后再选择该小区对应的楼栋信息，但是由于楼栋信息不易自动获取，只能伪造一些数据，利用随机数来生成一个楼号即可。</p>
<ol>
<li>通过编程式导航跳转到选择楼栋页面，<code>house_pkg/pages/locate/index</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;locate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;当前地点&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;address&#125;&#125;&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">bind:tap</span>=<span class="string">&quot;chooseLocation&quot;</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-locate&quot;</span>&gt;</span>重新定位<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;附近社区&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 去掉 van-cell 的 url 属性，绑定 tap 事件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;points&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;item.title&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goBuilding&quot;</span> <span class="attr">mark:point</span>=<span class="string">&quot;&#123;&#123;item.title&#125;&#125;&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>🤔 提示：<code>van-cell</code> 组件本身支持页面跳转，为其指定一个 url 属性即可，但是本节中咱们监听点击事件通过 wx.navigateTo 实现跳转，这样做的目的是讲解一个 <code>mark:*=&quot;xxx&quot;</code> 的应用，它是用来向事件回调传递参数的一种方式，功能有点类似于自定义属性 <code>data-*</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/locate/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">goBuilding</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/house_pkg/pages/building/index?point=&#x27;</span> + ev.mark.point,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>伪造楼栋信息，定义生成随机整数的方法，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Math/random">链接</a>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> utils = &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">getRandomIntInclusive</span>(<span class="params">min, max</span>)</span> &#123;</span><br><span class="line">        min = <span class="built_in">Math</span>.ceil(min);</span><br><span class="line">        max = <span class="built_in">Math</span>.floor(max);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * (max - min + <span class="number">1</span>)) + min; <span class="comment">//含最大值，含最小值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/building/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">point</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">size</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        point</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 伪造数进行渲染</span></span><br><span class="line">        <span class="built_in">this</span>.fake(point)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">fake</span>(<span class="params">point</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 伪造楼栋/号数据（仅用于授课）</span></span><br><span class="line">        <span class="comment">// size 是一个 3 ~ 6 的随机数</span></span><br><span class="line">        <span class="keyword">const</span> size = wx.utils.getRandomIntInclusive(<span class="number">3</span>, <span class="number">6</span>)</span><br><span class="line">        <span class="keyword">const</span> type = size &gt; <span class="number">4</span> ? <span class="string">&#x27;号楼&#x27;</span> : <span class="string">&#x27;栋&#x27;</span></span><br><span class="line">        <span class="comment">// 更新数据，重新渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            point, <span class="comment">// 小区</span></span><br><span class="line">            size, <span class="comment">// 楼的数量</span></span><br><span class="line">            type <span class="comment">// &quot;号楼&quot; or &quot;栋&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>🤔 伪造的数据没有特别的要求，只要产生一系列的随机数即可。</p>
<ol start="3">
<li>将生成的随机数渲染页面当中，<code>house_pkg/pages/building/index</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;building&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 小程序中 `wx:for` 支持以纯数字方式重复执行 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;size&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;*this&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;point&#125;&#125; &#123;&#123;item + 1&#125;&#125; &#123;&#123;type&#125;&#125;&quot;</span> <span class="attr">mark:building</span>=<span class="string">&quot;&#123;&#123;item + 1&#125;&#125;&#123;&#123;type&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goRoom&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="选择房间"><a href="#选择房间" class="headerlink" title="选择房间"></a>选择房间</h4><p>在用户确定了某个小区的楼栋信息后，再伪造一些数据，利用随机数来生成房间号。</p>
<ol>
<li>跳转到选择房间页面并传递相关参数，<code>house_pkg/pages/building/index</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;building&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;size&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;*this&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;point&#125;&#125; &#123;&#123;item + 1&#125;&#125; &#123;&#123;type&#125;&#125;&quot;</span> <span class="attr">mark:building</span>=<span class="string">&quot;&#123;&#123;item + 1&#125;&#125; &#123;&#123;type&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goRoom&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>🤔 提示: <code>van-cell</code> 组件本身支持页面跳转，为其指定一个 url 属性即可，但是本节中咱们监听点击事件通过 wx.navigateTo 实现跳转，这样做的目的是讲解一个 <code>mark:*=&quot;xxx&quot;</code> 的应用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">goRoom</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 跳转到选择房间页面</span></span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">`/house_pkg/pages/room/index?point=<span class="subst">$&#123;<span class="built_in">this</span>.data.point&#125;</span>&amp;building=<span class="subst">$&#123;ev.mark.building&#125;</span>`</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>随机若干个房间，<code>house_pkg/pages/room/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">point</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">building</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">rooms</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        point,</span></span></span><br><span class="line"><span class="params"><span class="function">        building</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 伪造房间数据</span></span><br><span class="line">        <span class="built_in">this</span>.fake(<span class="built_in">decodeURIComponent</span>(point), <span class="built_in">decodeURIComponent</span>(building))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">fake</span>(<span class="params">point, building</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 4 ~ 8</span></span><br><span class="line">        <span class="comment">// 表示房间数量</span></span><br><span class="line">        <span class="keyword">const</span> size = wx.utils.getRandomIntInclusive(<span class="number">4</span>, <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">const</span> rooms = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="comment">// 随机楼层号</span></span><br><span class="line">            <span class="keyword">const</span> floor = wx.utils.getRandomIntInclusive(<span class="number">1</span>, <span class="number">20</span>)</span><br><span class="line">            <span class="comment">// 随机房间号</span></span><br><span class="line">            <span class="keyword">const</span> No = wx.utils.getRandomIntInclusive(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">            <span class="comment">// 组合楼层和房间号</span></span><br><span class="line">            <span class="keyword">const</span> room = [floor, <span class="number">0</span>, No].join(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="comment">// 不允许重复的房间号</span></span><br><span class="line">            <span class="keyword">if</span> (rooms.includes(room)) <span class="keyword">continue</span></span><br><span class="line">            <span class="comment">// 记录房间号</span></span><br><span class="line">            rooms.push(room)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            point, <span class="comment">// 小区</span></span><br><span class="line">            building, <span class="comment">// &quot;x 号楼&quot; or &quot;x 栋&quot;</span></span><br><span class="line">            rooms <span class="comment">// 房间号</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>渲染随机生成的数据到页面当中，<code>house_pkg/pages/room/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;room&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;rooms&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;*this&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;point&#125;&#125; &#123;&#123;building&#125;&#125; &#123;&#123;item&#125;&#125;&quot;</span> <span class="attr">mark:room</span>=<span class="string">&quot;&#123;&#123;item&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goForm&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>接下来将这些信息做为地址参数传递到下一个表单页面，继续完善房屋的具体信息，如业主姓名、手机号等。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/room/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">goForm</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取小区和楼栋信息</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            point,</span><br><span class="line">            building</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">`/house_pkg/pages/form/index?point=<span class="subst">$&#123;point&#125;</span>&amp;building=<span class="subst">$&#123;building&#125;</span>&amp;room=<span class="subst">$&#123;ev.mark.room&#125;</span>`</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="添加房屋-1"><a href="#添加房屋-1" class="headerlink" title="添加房屋"></a>添加房屋</h4><ol>
<li>获取地址参数，<code>house_pkg/pages/form/index.js</code>。</li>
</ol>
<p>通过地址参数传递了小区名、楼栋号和房间号等信息，这些信息不仅要展示在页面当中，在提交数据时也需要发送到服务端。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        point,</span></span></span><br><span class="line"><span class="params"><span class="function">        building,</span></span></span><br><span class="line"><span class="params"><span class="function">        room</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取并记录地址参数</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            point,</span><br><span class="line">            building,</span><br><span class="line">            room</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将获取的小区名、楼栋号和房间号等信息展示到页面当中，<code>house_pkg/pages/from/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;房屋信息&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;point&#125;&#125; &#123;&#123;building&#125;&#125; &#123;&#123;room&#125;&#125;&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>表单数据校验。</li>
</ol>
<p>用 <code>model:value</code> 分别获取业主姓名、业主性别、业主手机号数据， <code>house_pkg/pages/form/index.wxml</code> 。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;房屋信息&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;point&#125;&#125; &#123;&#123;building&#125;&#125; &#123;&#123;room&#125;&#125;&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;业主信息&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- #1 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;name&#125;&#125;&quot;</span> <span class="attr">label</span>=<span class="string">&quot;姓名&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请填写您的真实姓名&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;性别&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- #2 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-radio-group</span> <span class="attr">direction</span>=<span class="string">&quot;horizontal&quot;</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123; gender &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- #3 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">van-radio</span> <span class="attr">icon-size</span>=<span class="string">&quot;36rpx&quot;</span> <span class="attr">checked-color</span>=<span class="string">&quot;#5591AF&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&#123;&#123;1&#125;&#125;&quot;</span>&gt;</span>男<span class="tag">&lt;/<span class="name">van-radio</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- #4 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">van-radio</span> <span class="attr">icon-size</span>=<span class="string">&quot;36rpx&quot;</span> <span class="attr">checked-color</span>=<span class="string">&quot;#5591AF&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&#123;&#123;0&#125;&#125;&quot;</span>&gt;</span>女<span class="tag">&lt;/<span class="name">van-radio</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">van-radio-group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- #5 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;mobile&#125;&#125;&quot;</span> <span class="attr">label</span>=<span class="string">&quot;手机号&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入您的手机号&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-upload&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;本人身份证照片&quot;</span> <span class="attr">label</span>=<span class="string">&quot;请拍摄证件原件，并使照片中证件边缘完整，文字清晰，光线均匀。&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-front&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- #6 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-remove&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardFrontUrl&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;removePicture&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;upload-button&quot;</span> <span class="attr">wx:else</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-add&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span>上传人像面照片<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-back&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- #7 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-remove&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardBackUrl&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;removePicture&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;upload-button&quot;</span> <span class="attr">wx:else</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-add&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span>上传国徽面照片<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goList&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-check&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>提交审核<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> <code>house_pkg/pages/form/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">gender</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">mobile</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">idcardFrontUrl</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">idcardBackUrl</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        point,</span></span></span><br><span class="line"><span class="params"><span class="function">        building,</span></span></span><br><span class="line"><span class="params"><span class="function">        room</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取并记录地址参数</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            point,</span><br><span class="line">            building,</span><br><span class="line">            room</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 验证业主姓名</span></span><br><span class="line">    <span class="function"><span class="title">verifyName</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证业主姓名（必须为汉字）</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[\u4e00-\u9fa5]&#123;2,5&#125;$/</span></span><br><span class="line">        <span class="comment">// 验证业主姓名</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.name.trim())</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写真实中文姓名!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">verifyMobile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证手机号</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[1][3-8][0-9]&#123;9&#125;$/</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.mobile)</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写正确的手机号码!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">verifyPicture</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 图片地址不能为空</span></span><br><span class="line">        <span class="keyword">const</span> valid = !!<span class="built_in">this</span>.data.idcardBackUrl &amp;&amp; !!<span class="built_in">this</span>.data.idcardFrontUrl</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请上传身份证照片!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>点击提交审核按钮后验证表单的数据。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;submitForm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-check&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>提交审核<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单的数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyName()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyPicture()) <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>上传身份证照片（讲解已有的代码交互）。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-upload&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;本人身份证照片&quot;</span> <span class="attr">label</span>=<span class="string">&quot;请拍摄证件原件，并使照片中证件边缘完整，文字清晰，光线均匀。&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-front&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果存在图片地址就显示身份证正面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 删除功能 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-remove&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardFrontUrl&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;removePicture&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 否则显示上传按钮 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;upload-button&quot;</span> <span class="attr">wx:else</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-add&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span>上传人像面照片<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-back&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 如果存在图片地址就显示身份证反面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 删除功能 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-remove&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardBackUrl&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;removePicture&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 否则显示上传按钮 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;upload-button&quot;</span> <span class="attr">wx:else</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-add&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span>上传国徽面照片<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>删除功能的代码， <code>house_pkg/pages/form/index.js</code> 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">removePicture</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 移除图片的类型（身份证正面或反面）</span></span><br><span class="line">        <span class="keyword">const</span> type = ev.mark.type</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            [type]: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>接下来为上传按钮添加点击事件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/from/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-upload&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;本人身份证照片&quot;</span> <span class="attr">label</span>=<span class="string">&quot;请拍摄证件原件，并使照片中证件边缘完整，文字清晰，光线均匀。&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-front&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-remove&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardFrontUrl&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;removePicture&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span> <span class="attr">class</span>=<span class="string">&quot;upload-button&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;uploadPicture&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardFrontUrl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-add&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span>上传人像面照片</span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-back&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-preview&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;image-remove&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardBackUrl&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;removePicture&quot;</span>&gt;</span>x<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span> <span class="attr">class</span>=<span class="string">&quot;upload-button&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;uploadPicture&quot;</span> <span class="attr">mark:type</span>=<span class="string">&quot;idcardBackUrl&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-add&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span>上传国徽面照片</span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过 <code>mark:type=&quot;idcardFrontUrl&quot;</code> 和 <code>mark:type=&quot;idcardBackUrl&quot;</code> 来区分用户点击的是上传身份证正面还是身份证的反面，其中。</p>
<ul>
<li><p>idcardFrontUrl 表示身份证的正面。</p>
</li>
<li><p>idcardBackUrl 表示身份证的反面。</p>
</li>
</ul>
<p>在上传图片之前再来介绍小程序的一个 API <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/media/video/wx.chooseMedia.html">wx.chooseMedia()</a>，通过这个 API 用户可以打开相机拍照或从机册中选择图片，其语法格式如下所示。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wx.chooseMedia(&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">1</span>, <span class="comment">// 只能选择1张图片</span></span><br><span class="line">    <span class="attr">mediaType</span>: [<span class="string">&#x27;image&#x27;</span>], <span class="comment">// 只能选择图片类型</span></span><br><span class="line">    <span class="attr">sizeType</span>: [<span class="string">&#x27;compressed&#x27;</span>], <span class="comment">// 默认为压缩模式</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>用户拍照或从机册中选择一张图片后将这张照片上传到服务器，接口信息如下所示。</li>
</ol>
<ul>
<li><p>接口路径：<code>/upload</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>file 后端接收上传文件的名称。</p>
</li>
<li><p>type 只有上传头像时才需要传该参数。</p>
</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672275">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">uploadPicture</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 上传身份证照片的类别</span></span><br><span class="line">        <span class="keyword">const</span> type = ev.mark.type</span><br><span class="line">        <span class="comment">// 选择图片</span></span><br><span class="line">        <span class="keyword">const</span> media = <span class="keyword">await</span> wx.chooseMedia(&#123;</span><br><span class="line">            <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">mediaType</span>: [<span class="string">&#x27;image&#x27;</span>],</span><br><span class="line">            <span class="attr">sizeType</span>: [<span class="string">&#x27;compressed&#x27;</span>],</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用接口上传图片</span></span><br><span class="line">        wx.uploadFile(&#123;</span><br><span class="line">            <span class="attr">url</span>: wx.http.baseURL + <span class="string">&#x27;/upload&#x27;</span>,</span><br><span class="line">            <span class="attr">filePath</span>: media.tempFiles[<span class="number">0</span>].tempFilePath,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="attr">Authorization</span>: getApp().token,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 转换 json 数据</span></span><br><span class="line">                <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(res.data)</span><br><span class="line">                <span class="comment">// 检测接口调用结果</span></span><br><span class="line">                <span class="keyword">if</span> (data.code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;上传图片失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 保存并预览图片地址</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    [type]: data.data.url,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>调用接口将表单数据提交给服务端。</li>
</ol>
<ul>
<li><p>接口路径：<code>/room</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>point 小区的名称，如育新花园。</p>
</li>
<li><p>building 楼栋号，如 5号楼。</p>
</li>
<li><p>room 房间号，如 302。</p>
</li>
<li><p>name 业主姓名。</p>
</li>
<li><p>gender 性别，0 表示女，1 表示男。</p>
</li>
<li><p>mobile 业主手机号。</p>
</li>
<li><p>idcardFrontUrl 身份证正面。</p>
</li>
<li><p>idcardBackUrl 身份证反面。</p>
</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400753">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/form/index.wxml</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单的数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyName()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyPicture()) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除小程序自带的不需要提交到后端的数据</span></span><br><span class="line">        <span class="keyword">delete</span> <span class="built_in">this</span>.data.__webviewId__</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/room&#x27;</span>, <span class="built_in">this</span>.data)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;添加房屋失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 成功后跳转至房屋列表</span></span><br><span class="line">        wx.navigateBack(&#123;</span><br><span class="line">            <span class="attr">delta</span>: <span class="number">4</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(house): 完成了房屋添加的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="房屋列表"><a href="#房屋列表" class="headerlink" title="房屋列表"></a>房屋列表</h3><ol>
<li>onShow 的时候直接调用接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/room</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400750">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">dialogVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.getHouseList()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getHouseList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: houseList</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/room&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 渲染数据</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseList</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>返回的数据当中 status 表示当前房屋的审核状态。</p>
<ul>
<li><p>值为 1 表示正在审核。</p>
</li>
<li><p>值为 2 表示审核成功。</p>
</li>
<li><p>值为 3 表示审核失败。</p>
</li>
</ul>
<ol start="2">
<li>渲染房屋列表，<code>house_pkg/pages/list/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;true&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">enhanced</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;houses&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;houses-title&quot;</span>&gt;</span>房屋信息<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;houses-list&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">van-swipe-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;houseList&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">async-close</span> <span class="attr">bind:close</span>=<span class="string">&quot;swipeClose&quot;</span> <span class="attr">right-width</span>=<span class="string">&quot;&#123;&#123; 70 &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goDetail&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">size</span>=<span class="string">&quot;large&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;item.point&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag info&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 1&#125;&#125;&quot;</span>&gt;</span>正在审核<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag success&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 2&#125;&#125;&quot;</span>&gt;</span>审核通过<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag fail&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 3&#125;&#125;&quot;</span>&gt;</span>审核失败<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;房间号&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.building&#125;&#125;&#123;&#123;item.room&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;业主&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.name&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">view</span> <span class="attr">slot</span>=<span class="string">&quot;right&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">van-swipe-cell</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>为了方便开发测试，后端提供了一个接口专门用来修改房屋<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672273">审核状态的接口</a>，直接在 apifox 在线调用接口即可。</li>
</ol>
<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(house): 完成查询房到列表&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="删除房屋"><a href="#删除房屋" class="headerlink" title="删除房屋"></a>删除房屋</h3><ol>
<li>准备 van-dialog 确认框组件，该组件使用数据 dialogVisible 控制其显示或隐藏。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/list.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-dialog</span> <span class="attr">message</span>=<span class="string">&quot;是否删除已绑定房屋？&quot;</span> <span class="attr">showCancelButton</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123;dialogVisible&#125;&#125;&quot;</span> <span class="attr">cancel-button-color</span>=<span class="string">&quot;#848484&quot;</span> <span class="attr">confirm-button-color</span>=<span class="string">&quot;#5591af&quot;</span> <span class="attr">bind:close</span>=<span class="string">&quot;dialogClose&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>用户滑动 van-swipe-cell 组件后点击了【删除】按钮后会调用 swipeClose 方法，然后显示 van-dialog 确认框组件，然后用户点击了 van-dialog 确认框组件中的【确认】按钮后会调用 dialogClose 方法。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">swipeClose</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            position,</span><br><span class="line">            instance</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="keyword">if</span> (position === <span class="string">&#x27;right&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 显示 Dialog 对话框</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                <span class="attr">dialogVisible</span>: <span class="literal">true</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// swiper-cell 滑块关闭</span></span><br><span class="line">            instance.close()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">dialogClose</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(ev.detail)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>获取待删除房屋的 id（后端删除）和 index（前端用），可以通过 mark 来传递这两个参数。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/list/index.wxml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-swipe-cell</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;houseList&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">mark:index</span>=<span class="string">&quot;&#123;&#123;index&#125;&#125;&quot;</span> <span class="attr">mark:id</span>=<span class="string">&quot;&#123;&#123;item.id&#125;&#125;&quot;</span> <span class="attr">async-close</span> <span class="attr">bind:close</span>=<span class="string">&quot;swipeClose&quot;</span> <span class="attr">right-width</span>=<span class="string">&quot;&#123;&#123;70&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goDetail&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">size</span>=<span class="string">&quot;large&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;item.point&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag info&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 1&#125;&#125;&quot;</span>&gt;</span>正在审核<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag success&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 2&#125;&#125;&quot;</span>&gt;</span>审核通过<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag fail&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 3&#125;&#125;&quot;</span>&gt;</span>审核失败<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;房间号&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.building&#125;&#125;&#123;&#123;item.room&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;业主&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.name&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">slot</span>=<span class="string">&quot;right&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-swipe-cell</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/list/index.js</span></span><br><span class="line"><span class="keyword">let</span> house_id = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> house_index = <span class="number">0</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">swipeClose</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            position,</span><br><span class="line">            instance</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="keyword">if</span> (position === <span class="string">&#x27;right&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 显示 Dialog 对话框</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                <span class="attr">dialogVisible</span>: <span class="literal">true</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 待删除的房屋id和索引</span></span><br><span class="line">            house_id = ev.mark.id</span><br><span class="line">            house_index = ev.mark.index</span><br><span class="line">            <span class="comment">// swiper-cell 滑块关闭</span></span><br><span class="line">            instance.close()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在 dialogClose 方法中调用删除的接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>room/:id</code>。</p>
</li>
<li><p>请求方法: DELETE。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 待删除的房到 id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400746">见文档</a>。</p>
</li>
</ul>
<p>封装方法来调用接口删除房屋数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">deleteHouse</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.delete(<span class="string">&#x27;/room/&#x27;</span> + house_id)</span><br><span class="line">        <span class="comment">// 检测接口调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;删除房屋失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.data.houseList.splice(house_index, <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">houseList</span>: <span class="built_in">this</span>.data.houseList,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">dialogClose</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 选择了确认后删除房屋</span></span><br><span class="line">        ev.detail === <span class="string">&#x27;confirm&#x27;</span> &amp;&amp; <span class="built_in">this</span>.deleteHouse()</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>优化数据为空时的页面展示，<code>house_pkg/page/list/index.wxml</code>。</li>
</ol>
<p>当所有的房屋都被删除后，或最开始获取页面列表时，在页面中给用户一个空提示。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;!isEmpty&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span> <span class="attr">class</span>=<span class="string">&quot;blank&quot;</span>&gt;</span></span><br><span class="line">        您还没有认证房屋，请点击 <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">class</span>=<span class="string">&quot;link&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/house_pkg/pages/locate/index&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">deleteHouse</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.delete(<span class="string">&#x27;/room/&#x27;</span> + house_id)</span><br><span class="line">        <span class="comment">// 检测接口调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;删除房屋失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.data.houseList.splice(house_index, <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">houseList</span>: <span class="built_in">this</span>.data.houseList,</span><br><span class="line">            <span class="comment">// #1</span></span><br><span class="line">            <span class="attr">isEmpty</span>: <span class="built_in">this</span>.data.houseList.length === <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getHouseList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: houseList</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/room&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 渲染数据</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseList,</span><br><span class="line">            <span class="comment">// #2</span></span><br><span class="line">            <span class="attr">isEmpty</span>: houseList.length === <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(house): 完成删除房屋的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="房屋详情"><a href="#房屋详情" class="headerlink" title="房屋详情"></a>房屋详情</h3><ol>
<li>跳转到详情页面时传递房屋 ID。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">goDetail</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/house_pkg/pages/detail/index?id=&#x27;</span> + ev.mark.id,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>根据房屋 ID 获取详情，<code>house_pkg/pages/detail/index.js</code>。</li>
</ol>
<ul>
<li><p>接口路径：<code>/room/:id</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 房屋id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400751">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取房屋详情</span></span><br><span class="line">        <span class="built_in">this</span>.getHouseDetail(id)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getHouseDetail</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!id) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: houseDetail</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/room/&#x27;</span> + id)</span><br><span class="line">        <span class="comment">// 检测接口返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 渲染数据</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            ...houseDetail</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">editHouse</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/house_pkg/pages/form/index&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>渲染数据到模板中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- house_pkg/pages/detail/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-y</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;house-detail&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;房屋信息&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- #1 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;point&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- #2 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag info&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 1&#125;&#125;&quot;</span>&gt;</span>正在审核<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag success&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 2&#125;&#125;&quot;</span>&gt;</span>审核成功<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag fail&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 3&#125;&#125;&quot;</span>&gt;</span>审核失败<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">title</span>=<span class="string">&quot;业主信息&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- #3 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;房间号&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;building&#125;&#125; &#123;&#123;room&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- #4 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;业主&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;name&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- #5 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;手机号&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;mobile&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;本人身份证照片&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-front&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- #6 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardFrontUrl&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;id-card-back&quot;</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- #7 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;idcardBackUrl&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(house): 完成查询房屋详情的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="编辑房屋"><a href="#编辑房屋" class="headerlink" title="编辑房屋"></a>编辑房屋</h3><p>编辑和添加房屋的逻辑是相似的并且共用了相同的页面，即 <code>house_pkg/pages/form/index</code> ，在此页面需要根据有无 ID 进行区分。</p>
<ol>
<li>点击【修改房屋信息】时传递 ID。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// miniprogram/house_pkg/pages/detail/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">editHouse</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/house_pkg/pages/form/index?id=&#x27;</span> + <span class="built_in">this</span>.data.id,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置页面标题，如果页面地址中包含 id 参数则表明当前的操作为编辑房屋信息。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        point,</span></span></span><br><span class="line"><span class="params"><span class="function">        building,</span></span></span><br><span class="line"><span class="params"><span class="function">        room,</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            wx.setNavigationBarTitle(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;编辑房屋信息&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 获取并记录地址参数</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                point,</span><br><span class="line">                building,</span><br><span class="line">                room</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>根据 ID 查询房屋详情数据。</li>
</ol>
<ul>
<li><p>接口路径：<code>/room/:id</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 房屋id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400751">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        point,</span></span></span><br><span class="line"><span class="params"><span class="function">        building,</span></span></span><br><span class="line"><span class="params"><span class="function">        room,</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            wx.setNavigationBarTitle(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;编辑房屋信息&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// 获取房屋信息</span></span><br><span class="line">            <span class="built_in">this</span>.getHouseDetail(id)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 获取并记录地址参数</span></span><br><span class="line">            <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                point,</span><br><span class="line">                building,</span><br><span class="line">                room</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getHouseDetail</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!id) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: houseDetail</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/room/&#x27;</span> + id)</span><br><span class="line">        <span class="comment">// 检测接口返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast()</span><br><span class="line">        <span class="comment">// 渲染数据</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            ...houseDetail</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>调用更新房屋信息的接口。</li>
</ol>
<ul>
<li><p>添加房屋和更新房屋信息调用的是同一个接口，后端会动判断传递参数时有没有 id，如果有 id 则表示是编辑操作否则是添加操作。</p>
</li>
<li><p>要注意接口参数中并不包含 status 这个参数，这个数据是标识房屋的审核状态的，在调用接口前我们把这个参数删除。</p>
</li>
<li><p>要注意接口调用成功后的返回操作也需要做一些调整。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// house_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单的数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyName()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyPicture()) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除一些数据</span></span><br><span class="line">        <span class="keyword">delete</span> <span class="built_in">this</span>.data.__webviewId__</span><br><span class="line">        <span class="comment">// #1</span></span><br><span class="line">        <span class="keyword">delete</span> <span class="built_in">this</span>.data.status</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/room&#x27;</span>, <span class="built_in">this</span>.data)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;添加房屋失败!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// #2 成功后跳转至房屋列表</span></span><br><span class="line">        wx.navigateBack(&#123;</span><br><span class="line">            <span class="attr">delta</span>: <span class="built_in">this</span>.data.id ? <span class="number">2</span> : <span class="number">4</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(house): 完成房屋编辑的功能&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到远程或合并到本地 main</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge feat-house</span><br></pre></td></tr></table></figure>

<h2 id="报修管理"><a href="#报修管理" class="headerlink" title="报修管理"></a>报修管理</h2><h3 id="在线报修"><a href="#在线报修" class="headerlink" title="在线报修"></a>在线报修</h3><p>用户在线填写报修的信息，所涉及的功能主要是文件上传、表单验证等技术点。</p>
<h4 id="用户交互"><a href="#用户交互" class="headerlink" title="用户交互"></a>用户交互</h4><p>本页面有 3 个重要的交互，分别用到了 <a target="_blank" rel="noopener" href="https://vant-contrib.gitee.io/vant-weapp/#/action-sheet">van-action-sheet</a>、<a target="_blank" rel="noopener" href="https://vant-contrib.gitee.io/vant-weapp/#/datetime-picker">van-datetime-picker</a> 以及 <a target="_blank" rel="noopener" href="https://vant-contrib.gitee.io/vant-weapp/#/popup">van-popup</a> 组件，使用下面 3 个变量来控制是否展示组件。</p>
<ul>
<li><p>houseLayerVisible 是否展示房屋列表。</p>
</li>
<li><p>repairLayerVisible 是否展示维修项目。</p>
</li>
<li><p>dateLayerVisible 是否显示日期选择。</p>
</li>
</ul>
<p>通过改变这 3 个变量的值来切换组件的显示/隐藏。</p>
<ol>
<li>【请选择报修的房屋】，监听 select 事件，在事件回调函数中<strong>获取用户所选择的内容</strong>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-action-sheet</span> <span class="attr">bind:close</span>=<span class="string">&quot;closeHouseLayer&quot;</span> <span class="attr">bind:cancel</span>=<span class="string">&quot;closeHouseLayer&quot;</span> <span class="attr">bind:select</span>=<span class="string">&quot;selectHouse&quot;</span> <span class="attr">round</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123; houseLayerVisible &#125;&#125;&quot;</span> <span class="attr">actions</span>=<span class="string">&quot;&#123;&#123; houseList &#125;&#125;&quot;</span> <span class="attr">cancel-text</span>=<span class="string">&quot;取消&quot;</span> <span class="attr">title</span>=<span class="string">&quot;选择报修房屋&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">houseInfo</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">selectHouse</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户选择房屋的名称</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="attr">name</span>: houseInfo</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="comment">// 页面中渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseInfo</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>渲染 houseInfo，用户在房屋列表中选择了某个房屋项后需要高亮显示，只要添加 active-cell 类名即可。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;报修房屋&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;houseInfo || &#x27;请选择报修房屋&#x27;&#125;&#125;&quot;</span> <span class="attr">value-class</span>=<span class="string">&quot;&#123;&#123;houseInfo &amp;&amp; &#x27;active-cell&#x27;&#125;&#125;&quot;</span> <span class="attr">bind:click</span>=<span class="string">&quot;openHouseLayer&quot;</span> <span class="attr">is-link</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>【请选择维修项目】，监听 select 事件，在事件回调函数中<strong>获取用户所选择的内容</strong>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-action-sheet</span> <span class="attr">bind:close</span>=<span class="string">&quot;closeRepairLayer&quot;</span> <span class="attr">bind:cancel</span>=<span class="string">&quot;closeRepairLayer&quot;</span> <span class="attr">bind:select</span>=<span class="string">&quot;selectRepairItem&quot;</span> <span class="attr">round</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123; repairLayerVisible &#125;&#125;&quot;</span> <span class="attr">actions</span>=<span class="string">&quot;&#123;&#123; repairItem &#125;&#125;&quot;</span> <span class="attr">cancel-text</span>=<span class="string">&quot;取消&quot;</span> <span class="attr">title</span>=<span class="string">&quot;选择维修项目&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">repairItemName</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">selectRepairItem</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户选择的维修项目名称</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="attr">name</span>: repairItemName</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="comment">// 页面中渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            repairItemName</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>渲染 repairItemName，高亮同样添加 active-cell 类名即可。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">title</span>=<span class="string">&quot;维修项目&quot;</span> <span class="attr">bind:click</span>=<span class="string">&quot;openRepairLayer&quot;</span> <span class="attr">value-class</span>=<span class="string">&quot;&#123;&#123;repairItemName &amp;&amp; &#x27;active-cell&#x27;&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;repairItemName || &#x27;请选择维修项目&#x27;&#125;&#125;&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>监听日期选择后的 confirm 事件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-popup</span> <span class="attr">bind:close</span>=<span class="string">&quot;closeDateLayer&quot;</span> <span class="attr">round</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123;dateLayerVisible&#125;&#125;&quot;</span> <span class="attr">position</span>=<span class="string">&quot;bottom&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-datetime-picker</span> <span class="attr">type</span>=<span class="string">&quot;date&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;currentDate&#125;&#125;&quot;</span> <span class="attr">min-date</span>=<span class="string">&quot;&#123;&#123;minDate&#125;&#125;&quot;</span> <span class="attr">bind:cancel</span>=<span class="string">&quot;closeDateLayer&quot;</span> <span class="attr">bind:confirm</span>=<span class="string">&quot;selectDate&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-popup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">appointment</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">selectDate</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">dateLayerVisible</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">appointment</span>: wx.utils.formatDate(ev.detail),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p> <code>miniprogram/utils/utils.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 工具方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> utils = &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 封装 wx.showToast</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>title 消息提示的内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">toast</span>(<span class="params">title = <span class="string">&#x27;数据加载失败...&#x27;</span></span>)</span> &#123;</span><br><span class="line">        wx.showToast(&#123;</span><br><span class="line">            title,</span><br><span class="line">            <span class="attr">mask</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">formatDate</span>(<span class="params">timestamp</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>(timestamp)</span><br><span class="line">        <span class="keyword">const</span> year = date.getFullYear()</span><br><span class="line">        <span class="keyword">const</span> month = date.getMonth() + <span class="number">1</span></span><br><span class="line">        <span class="keyword">const</span> day = date.getDate()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [year, month, day].map(<span class="built_in">this</span>.formatNumber).join(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">formatNumber</span>(<span class="params">n</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> s = n.toString()</span><br><span class="line">        <span class="keyword">return</span> s[<span class="number">1</span>] ? s : <span class="string">&#x27;0&#x27;</span> + s</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扩展 wx 全局对象，切记不要与原用 api 重名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">wx.utils = utils</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模块化导出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> utils</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>渲染 appointment。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">title</span>=<span class="string">&quot;预约日期&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;appointment || &#x27;请选择上门维修日期&#x27;&#125;&#125;&quot;</span> <span class="attr">value-class</span>=<span class="string">&quot;&#123;&#123;appointment &amp;&amp; &#x27;active-cell&#x27;&#125;&#125;&quot;</span> <span class="attr">bind:click</span>=<span class="string">&quot;openDateLayer&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成在线报修的交互处理&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="房屋列表-1"><a href="#房屋列表-1" class="headerlink" title="房屋列表"></a>房屋列表</h4><p>获取真实的后端返回的房屋列表。</p>
<ul>
<li><p>接口路径：<code>/house</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42635315">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="comment">// #1</span></span><br><span class="line">        <span class="attr">houseList</span>: [],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #2 获取房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.getHouseList()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getHouseList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #3 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: houseList</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/house&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取房屋列表失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 数据渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseList</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>🤔 提示：这里只能查询到通过审核通过的房屋信息，通过这个<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672273">接口</a>可以修改审核后状态进行测试。</p>
<h4 id="维修项目"><a href="#维修项目" class="headerlink" title="维修项目"></a>维修项目</h4><p>获取真实的后端返回的维修项目。</p>
<ul>
<li><p>接口路径：<code>/repairItem</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400758">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="comment">// #1</span></span><br><span class="line">        <span class="attr">repairItem</span>: [],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #2 获取维修项目</span></span><br><span class="line">        <span class="built_in">this</span>.getRepairItem()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getRepairItem</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #3 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: repairItem</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/repairItem&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口返回的数据</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取维修项目失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 数据渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            repairItem</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h4><ol>
<li>监听 after-read 事件，当用户选择了一张图片后会触发该事件，在该事件回调中执行文件上传的逻辑。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">use-label-slot</span> <span class="attr">custom-style</span>=<span class="string">&quot;padding-bottom: 0&quot;</span> <span class="attr">title</span>=<span class="string">&quot;问题附件&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;uploader&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;label&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 20rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-uploader</span> <span class="attr">preview-size</span>=<span class="string">&quot;100&quot;</span> <span class="attr">bind:after-read</span>=<span class="string">&quot;afterRead&quot;</span> <span class="attr">file-list</span>=<span class="string">&quot;&#123;&#123; fileList &#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">afterRead</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(ev.detail.file)</span></span><br><span class="line">        <span class="comment">// 临时文件</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            file</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取到临时图片路径后调用接口将其上传到服务器。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">attachment</span>: [],</span><br><span class="line">        <span class="comment">// 这个数据不需要了，可以删除</span></span><br><span class="line">        <span class="comment">// fileList: []</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">afterRead</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// console.log(ev.detail.file)</span></span><br><span class="line">        <span class="comment">// 临时文件</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            file</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="comment">// 调用接口上传至服务器</span></span><br><span class="line">        wx.uploadFile(&#123;</span><br><span class="line">            <span class="attr">url</span>: wx.http.baseURL + <span class="string">&#x27;/upload&#x27;</span>,</span><br><span class="line">            <span class="attr">filePath</span>: file.url,</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="attr">Authorization</span>: getApp().token,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 转换 json 数据</span></span><br><span class="line">                <span class="keyword">const</span> data = <span class="built_in">JSON</span>.parse(res.data)</span><br><span class="line">                <span class="comment">// 上传完成需要更新</span></span><br><span class="line">                <span class="keyword">const</span> &#123;</span><br><span class="line">                    attachment = []</span><br><span class="line">                &#125; = <span class="built_in">this</span>.data</span><br><span class="line">                attachment.push(&#123;</span><br><span class="line">                    ...data.data</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 渲染数据</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    attachment</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>🤔 提示：在写静态页面时存图片路径使用的是 fileList 数据，咱们这儿改成了 attchment（视图中的 fileList 也记得改成 attachment），原因是跟后端接口的需要对应起来。</p>
<ol start="3">
<li>通过 max-count 属性可以控制 van-uploader 组件的上传数量。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">use-label-slot</span> <span class="attr">custom-style</span>=<span class="string">&quot;padding-bottom: 0&quot;</span> <span class="attr">title</span>=<span class="string">&quot;问题附件&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;uploader&quot;</span> <span class="attr">slot</span>=<span class="string">&quot;label&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 20rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">van-uploader</span> <span class="attr">preview-size</span>=<span class="string">&quot;100&quot;</span> <span class="attr">bind:after-read</span>=<span class="string">&quot;afterRead&quot;</span> <span class="attr">max-count</span>=<span class="string">&quot;6&quot;</span> <span class="attr">file-list</span>=<span class="string">&quot;&#123;&#123;attachment&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成报修信息的数据处理&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="提交表单"><a href="#提交表单" class="headerlink" title="提交表单"></a>提交表单</h4><ol>
<li>补充获取维修房屋的 id 和 维修项目的 id。</li>
</ol>
<p>🤔 上一小节写交互逻辑时只获取到了维修房屋的名称和维修项目的名称。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">selectHouse</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户选择房屋的 id 和名称</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="attr">id</span>: houseId,</span><br><span class="line">            <span class="attr">name</span>: houseInfo</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="comment">// 页面中渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseId,</span><br><span class="line">            houseInfo</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">selectRepairItem</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取用户选择的维修项目及 id</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="attr">id</span>: repairItemId,</span><br><span class="line">            <span class="attr">name</span>: repairItemName</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="comment">// 页面中渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            repairItemId,</span><br><span class="line">            repairItemName</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>获取报修人手机号码和报修问题描述，使用 <code>model:value</code> 双向数据绑定即可。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">title-width</span>=<span class="string">&quot;88&quot;</span> <span class="attr">label</span>=<span class="string">&quot;手机号码&quot;</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;mobile&#125;&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入联系电话号码&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;100&quot;</span> <span class="attr">title</span>=<span class="string">&quot;预约日期&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;appointment || &#x27;请选择上门维修日期&#x27;&#125;&#125;&quot;</span> <span class="attr">value-class</span>=<span class="string">&quot;&#123;&#123;appointment &amp;&amp; &#x27;active-cell&#x27;&#125;&#125;&quot;</span> <span class="attr">bind:click</span>=<span class="string">&quot;openDateLayer&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">use-label-slot</span> <span class="attr">title</span>=<span class="string">&quot;问题描述&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-field</span> <span class="attr">slot</span>=<span class="string">&quot;label&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;description&#125;&#125;&quot;</span> <span class="attr">autosize</span> <span class="attr">custom-style</span>=<span class="string">&quot;padding: 0; font-size: 28rpx; min-height: 60rpx&quot;</span> <span class="attr">type</span>=<span class="string">&quot;textarea&quot;</span> <span class="attr">placeholder-style</span>=<span class="string">&quot;color: #c3c3c5;&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请填写报修内容，工作人员将快速帮您解决问题。&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>验证表单数据。</li>
</ol>
<p>🤔 在调用接口提交表单数据前必须要对用户填写数据的合法性进行验证，本小节的内容课堂就不写代码了，要求大家能读懂就可以。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">verifyHouse</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> valid = <span class="built_in">this</span>.data.houseId !== <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请选择房屋信息!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">verifyRepair</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> valid = <span class="built_in">this</span>.data.repairItemId !== <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请选择维修项目!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">verifyMobile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证手机号，记得给 mobile 一个默认值为 &#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[1][3-8][0-9]&#123;9&#125;$/</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.mobile.trim())</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写正确的手机号码!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">verifyDate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证日期格式</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^\d&#123;4&#125;\/\d&#123;2&#125;\/\d&#123;2&#125;$/</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.appointment)</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请选择预约日期!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">verifyDescription</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证报修项目描述，记得给 description 一个默认值为 &#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">const</span> valid = <span class="built_in">this</span>.data.description.trim() !== <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写问题描述!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>监听用户提交报修按钮的点击事件，调用接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/repair</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>houseId 报修房屋的 id。</p>
</li>
<li><p>repairItemId 报修项目的 id。</p>
</li>
<li><p>mobile 报修人电话号码。</p>
</li>
<li><p>appointment 预约上门维修时间。</p>
</li>
<li><p>description 维修问题描述。</p>
</li>
<li><p>attachment 维修问题照片。</p>
</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400754">见文档</a>。</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repari_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;submitForm&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-repair&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>提交报修<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #1 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyHouse()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyRepair()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyDate()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyDescription()) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// #2 解构获取接口需要的参数</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            houseId,</span><br><span class="line">            repairItemId,</span><br><span class="line">            appointment,</span><br><span class="line">            mobile,</span><br><span class="line">            description,</span><br><span class="line">            attachment</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line">        <span class="comment">// #3 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/repair&#x27;</span>, &#123;</span><br><span class="line">            houseId,</span><br><span class="line">            repairItemId,</span><br><span class="line">            appointment,</span><br><span class="line">            mobile,</span><br><span class="line">            description,</span><br><span class="line">            attachment</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// #4 检测接口请求的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.showToast(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;在线报修失败!&#x27;</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// #5 跳转到报修列表页面</span></span><br><span class="line">        wx.redirectTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/repair_pkg/pages/list/index&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成在线填写报修信息的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="报修列表"><a href="#报修列表" class="headerlink" title="报修列表"></a>报修列表</h3><ol>
<li>直接调用后端接口获取数据。</li>
</ol>
<ul>
<li><p>接口路径：<code>/repair</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>current 当前请求数据的页码。</p>
</li>
<li><p>pageSize 每页请求获得的数据条数。</p>
</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400755">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/list/index.wxml</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取报修列表</span></span><br><span class="line">        <span class="built_in">this</span>.getRepairList()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getRepairList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">rows</span>: repairList</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/repair&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">current</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">pageSize</span>: <span class="number">10</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取报修列表失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 渲染报修列表</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            repairList,</span><br><span class="line">            <span class="attr">isEmpty</span>: repairList.length === <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>返回的数据当中 status 表示当前报修项目进行的状态。</p>
<ul>
<li><p>值为 1 表示受理中，对应的样式类名 info。</p>
</li>
<li><p>值为 2 表示上门中，对应的样式类名 success。</p>
</li>
<li><p>值为 3 表示已完成，对应的样式类名 complete。</p>
</li>
<li><p>值为 0 表示已取消，对应的样式类名 cancel。</p>
</li>
</ul>
<ol start="2">
<li>在模板中渲染后端返回的数据。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/list/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;!isEmpty&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">enhanced</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;repairs&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;repairs-title&quot;</span>&gt;</span>我的报修<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;repairs-list&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;repairList&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goDetail&quot;</span> <span class="attr">mark:id</span>=<span class="string">&quot;&#123;&#123;item.id&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">size</span>=<span class="string">&quot;large&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;item.houseInfo&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag info&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 1&#125;&#125;&quot;</span>&gt;</span>受理中<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag success&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 2&#125;&#125;&quot;</span>&gt;</span>上门中<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag complete&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 3&#125;&#125;&quot;</span>&gt;</span>已完成<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag cancel&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 0&#125;&#125;&quot;</span>&gt;</span>已取消<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;报修项目&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.repairItemName&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;预约时间&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.appointment&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;电话号码&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.mobile&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;addRepair&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-repair&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>在线报修<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span> <span class="attr">class</span>=<span class="string">&quot;blank&quot;</span>&gt;</span></span><br><span class="line">        您还没有报修记录，请点击</span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">class</span>=<span class="string">&quot;link&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/repair_pkg/pages/form/index&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为了方便开发测试，后端提供了一个接口专门用来修改报修项目状态的<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42672273">接口</a>，直接在 apifox 在线调用接口即可。</p>
<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成查询报修列表的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="报修详情"><a href="#报修详情" class="headerlink" title="报修详情"></a>报修详情</h3><h4 id="数据渲染"><a href="#数据渲染" class="headerlink" title="数据渲染"></a>数据渲染</h4><ol>
<li>跳转到详情页面时，传递报修项目的 ID。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/list/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;repairList&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goDetail&quot;</span> <span class="attr">mark:id</span>=<span class="string">&quot;&#123;&#123;item.id&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">goDetail</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/repair_pkg/pages/detail/index?id=&#x27;</span> + ev.mark.id,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在详情页，根据接收到的 ID 请求数据。</li>
</ol>
<ul>
<li><p>接口路径：<code>/repair/:id</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 报修项目的 id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400757">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/detail/index.js</span></span><br><span class="line"><span class="keyword">let</span> repair_id = <span class="string">&#x27;&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取维修详情</span></span><br><span class="line">        <span class="built_in">this</span>.getRepairDetail((repair_id = id))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getRepairDetail</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// id 不存在就不必发请求了</span></span><br><span class="line">        <span class="keyword">if</span> (!id) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: repairDetail</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/repair/&#x27;</span> + id)</span><br><span class="line">        <span class="comment">// 校验接口调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取报修详情失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 渲染报修详情</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            ...repairDetail</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>渲染数据到模板中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/detail/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-y</span> <span class="attr">enhanced</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;repair-detail&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 地图组件，只有处于上门中状态才显示 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;polyline&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 2&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">map</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%; height: 100%;&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;16&quot;</span> <span class="attr">latitude</span>=<span class="string">&quot;&#123;&#123;latitude&#125;&#125;&quot;</span> <span class="attr">longitude</span>=<span class="string">&quot;&#123;&#123;longitude&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;房屋信息&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;houseInfo&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag info&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 1&#125;&#125;&quot;</span>&gt;</span>受理中<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag success&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 2&#125;&#125;&quot;</span>&gt;</span>上门中<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag complete&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 3&#125;&#125;&quot;</span>&gt;</span>已完成<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag cancel&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 0&#125;&#125;&quot;</span>&gt;</span>已取消<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">title</span>=<span class="string">&quot;报修信息&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;维修项目&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;repairItemName&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;手机号码&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;mobile&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;预约日期&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;appointment&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;问题描述&quot;</span> <span class="attr">label</span>=<span class="string">&quot;&#123;&#123;description&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;attachment&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>问题附件<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-x</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">image</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;attachment&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;item.url&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 只能受理中状态是才允许取消报修或修改报修 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 1&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-text active&quot;</span>&gt;</span>修改信息<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">bind:tap</span>=<span class="string">&quot;test&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>取消报修<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成查询报修项目详情的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="上门路线"><a href="#上门路线" class="headerlink" title="上门路线"></a>上门路线</h4><ol>
<li>小程序中有一个专门展示地址的组件 map，直接将组件写到页面当中就会展示地图，一些常用的组件属性如下。</li>
</ol>
<ul>
<li><p>latitude 地图中心的经度。</p>
</li>
<li><p>longitude 地图中心的纬度。</p>
</li>
<li><p>scale 地图初始的缩放比例。</p>
</li>
<li><p>markers 地图上的标记。</p>
</li>
<li><p>polyline 地图路线。</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span> <span class="attr">markers</span>=<span class="string">&quot;&#123;&#123;markers&#125;&#125;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%; height: 100%;&quot;</span> <span class="attr">scale</span>=<span class="string">&quot;14.5&quot;</span> <span class="attr">latitude</span>=<span class="string">&quot;&#123;&#123;markers[0].latitude&#125;&#125;&quot;</span> <span class="attr">longitude</span>=<span class="string">&quot;&#123;&#123;markers[0].longitude&#125;&#125;&quot;</span> <span class="attr">polyline</span>=<span class="string">&quot;&#123;&#123;[]&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/detail/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">markers</span>: [&#123;</span><br><span class="line">                <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="comment">// 学校</span></span><br><span class="line">                <span class="attr">latitude</span>: <span class="number">30.71326903396565</span>, <span class="comment">// 经度</span></span><br><span class="line">                <span class="attr">longitude</span>: <span class="number">114.40691808969243</span>, <span class="comment">// 纬度</span></span><br><span class="line">                <span class="attr">width</span>: <span class="number">24</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">30</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="comment">// 下贩新苑</span></span><br><span class="line">                <span class="attr">latitude</span>: <span class="number">30.71317488159291</span>,</span><br><span class="line">                <span class="attr">longitude</span>: <span class="number">114.39899701136655</span>,</span><br><span class="line">                <span class="attr">iconPath</span>: <span class="string">&#x27;/static/images/marker.png&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">40</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">40</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// &#123;</span></span><br><span class="line">            <span class="comment">//   id: 2,</span></span><br><span class="line">            <span class="comment">//   // 光谷佛祖岭 G 区</span></span><br><span class="line">            <span class="comment">//   latitude: 30.438011271240395,</span></span><br><span class="line">            <span class="comment">//   longitude: 114.46212300565537,</span></span><br><span class="line">            <span class="comment">//   iconPath: &#x27;/static/images/marker.png&#x27;,</span></span><br><span class="line">            <span class="comment">//   width: 40,</span></span><br><span class="line">            <span class="comment">//   height: 40,</span></span><br><span class="line">            <span class="comment">// &#125;,</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://www.metools.info/learn/jingweidu200.html">根据位置得到经纬度</a>，上述代码中的经纬度是学校和附近的一个小区，大家可以自由指定（两点距离不要相差太远）。</p>
<ol start="2">
<li>通过微信小程序的地图服务 <a target="_blank" rel="noopener" href="https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/methodDirection">SDK</a> 生成路线规划的坐标点。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> qqMap <span class="keyword">from</span> <span class="string">&#x27;../../../utils/qqmap&#x27;</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="built_in">this</span>.createPolyLine()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">createPolyLine</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #1 调用距离计算接口</span></span><br><span class="line">        qqMap.direction(&#123;</span><br><span class="line">            <span class="comment">// #2 交通工具的类型</span></span><br><span class="line">            <span class="attr">mode</span>: <span class="string">&#x27;bicycling&#x27;</span>,</span><br><span class="line">            <span class="comment">// #3 不填默认当前地址，从哪</span></span><br><span class="line">            <span class="attr">from</span>: <span class="string">&#x27;30.71317488159291,114.39899701136655&#x27;</span>, <span class="comment">// 下贩新苑</span></span><br><span class="line">            <span class="attr">to</span>: <span class="string">&#x27;30.71326903396565,114.40691808969243&#x27;</span>, <span class="comment">// 传智播客</span></span><br><span class="line">            <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> coords = res.result.routes[<span class="number">0</span>].polyline</span><br><span class="line">                <span class="keyword">const</span> points = []</span><br><span class="line">                <span class="comment">// #4 生成新的坐标点（地图的算法，无需关心）</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">2</span>; i &lt; coords.length; i++) &#123;</span><br><span class="line">                    coords[i] = <span class="built_in">Number</span>(coords[i - <span class="number">2</span>]) + <span class="built_in">Number</span>(coords[i]) / <span class="number">1000000</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// #5 将新的坐标点加工一下怼到需要的新数组格式</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; coords.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">                    points.push(&#123;</span><br><span class="line">                        <span class="attr">latitude</span>: coords[i],</span><br><span class="line">                        <span class="attr">longitude</span>: coords[i + <span class="number">1</span>]</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// #6 设置 polyline 属性，将路线显示出来</span></span><br><span class="line">                <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">                    <span class="attr">polyline</span>: [&#123;</span><br><span class="line">                        points,</span><br><span class="line">                        <span class="attr">color</span>: <span class="string">&#x27;#5591af&#x27;</span>,</span><br><span class="line">                        <span class="attr">width</span>: <span class="number">4</span>,</span><br><span class="line">                    &#125;, ],</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">fail</span>: <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.error(error)</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="取消报修"><a href="#取消报修" class="headerlink" title="取消报修"></a>取消报修</h3><p>当报修项目的状态处于<strong>受理中</strong>时，用户可以详情页面主动取消本次报修。</p>
<ol>
<li>准备一个确认提示框。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/detail/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-dialog</span> <span class="attr">message</span>=<span class="string">&quot;是否要取消本次报修？&quot;</span> <span class="attr">showCancelButton</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123;dialogVisible&#125;&#125;&quot;</span> <span class="attr">cancel-button-color</span>=<span class="string">&quot;#848484&quot;</span> <span class="attr">confirm-button-color</span>=<span class="string">&quot;#5591af&quot;</span> <span class="attr">bind:close</span>=<span class="string">&quot;dialogClose&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 dialogVisible 数据控制确认框是否显示。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">dialogVisible</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">dialogClose</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在用户点【取消报修】按钮后显示确认框。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 只能受理中状态是才允许取消报修或修改报修 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 1&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-text active&quot;</span>&gt;</span>修改信息<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">bind:tap</span>=<span class="string">&quot;openDialogLayer&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>取消报修<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// 打开确认框</span></span><br><span class="line">    <span class="function"><span class="title">openDialogLayer</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="attr">dialogVisible</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>监听弹框的关闭事件，当点击的是确定按钮时，调用取消报修的接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/cancel/repaire/:id</code>。</p>
</li>
<li><p>请求方法: PUT。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 报修项目的 id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400752">见文档</a>。</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">van-dialog</span> <span class="attr">message</span>=<span class="string">&quot;是否要取消本次报修？&quot;</span> <span class="attr">showCancelButton</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123;dialogVisible&#125;&#125;&quot;</span> <span class="attr">cancel-button-color</span>=<span class="string">&quot;#848484&quot;</span> <span class="attr">confirm-button-color</span>=<span class="string">&quot;#5591af&quot;</span> <span class="attr">bind:close</span>=<span class="string">&quot;dialogClose&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">cancelRepair</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.put(<span class="string">&#x27;/cancel/repaire/&#x27;</span> + repair_id)</span><br><span class="line">        <span class="comment">// 检测接口的调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;取消报修失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 跳转到报修列表页面</span></span><br><span class="line">        wx.navigateBack()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">dialogClose</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 选择了确认后取消报修</span></span><br><span class="line">        <span class="keyword">if</span> (ev.detail === <span class="string">&#x27;confirm&#x27;</span>) <span class="built_in">this</span>.cancelRepair()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成取消报修项目的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="修改信息"><a href="#修改信息" class="headerlink" title="修改信息"></a>修改信息</h3><p>修改报修信息要先根据报修项目的 id 将原来的报修信息查询出来，然后在对原数据进行修改后再调用接口来更新数据；修改报修信息和填写报修信息的逻辑是相似的并且共用了相同的页面，即 <code>repair_pkg/pages/form/index</code> 。</p>
<ol>
<li>给修改报修信息的按钮绑定点击事件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/detail/index.wxml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 只能受理中状态是才允许取消报修或修改报修 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;status === 1&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-text active&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;editRepair&quot;</span>&gt;</span>修改信息<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;openDialogLayer&quot;</span>&gt;</span>取消报修<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在事件会调用跳转到 form 表单并传递报修 ID。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/detail/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">editRepair</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="comment">// repair_id 是全局变量，在前面已经定义</span></span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/repair_pkg/pages/form/index?id=&#x27;</span> + repair_id,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>设置页面标题。</li>
</ol>
<p>如果页面地址中包含 id 参数则表明当前的操作为修改报修信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.getHouseList()</span><br><span class="line">        <span class="comment">// 获取维修项目</span></span><br><span class="line">        <span class="built_in">this</span>.getRepairItem()</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            <span class="comment">// 更新标题</span></span><br><span class="line">            wx.setNavigationBarTitle(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;修改报修信息&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>根据 ID 查询报修详情。</li>
</ol>
<ul>
<li><p>接口路径：<code>/repair/:id</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 报修项目的 id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400757">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.getHouseList()</span><br><span class="line">        <span class="comment">// 获取维修项目</span></span><br><span class="line">        <span class="built_in">this</span>.getRepairItem()</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            <span class="comment">// 更新标题</span></span><br><span class="line">            wx.setNavigationBarTitle(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;修改报修信息&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="built_in">this</span>.getRepairDetail(id)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getRepairDetail</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!id) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: repairDetail</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/repair/&#x27;</span> + id)</span><br><span class="line">        <span class="comment">// 检测接口调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取报修信息失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 渲染报修信息</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            ...repairDetail</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调用更新报修信息的接口。</li>
</ol>
<p>填写报修信息和修改房屋信息调用的是同一个接口，后端会动判断传递参数时有没有 id，如果有 id 则表示是编辑操作否则是添加操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 逐个验证表单数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyHouse()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyRepair()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyDate()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyDescription()) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 解构获取接口需要的参数</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            id,</span><br><span class="line">            houseId,</span><br><span class="line">            repairItemId,</span><br><span class="line">            appointment,</span><br><span class="line">            mobile,</span><br><span class="line">            description,</span><br><span class="line">            attachment</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/repair&#x27;</span>, &#123;</span><br><span class="line">            id,</span><br><span class="line">            houseId,</span><br><span class="line">            repairItemId,</span><br><span class="line">            appointment,</span><br><span class="line">            mobile,</span><br><span class="line">            description,</span><br><span class="line">            attachment</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 检测接口请求的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.showToast(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;在线报修失败!&#x27;</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 跳转到表单列表页面</span></span><br><span class="line">        wx.redirectTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/repair_pkg/pages/list/index&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成修改报修信息的功能&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到远程或合并到本地 main</span></span><br><span class="line">git checkout main</span><br><span class="line">git merge feat-house</span><br></pre></td></tr></table></figure>

<h2 id="访客管理"><a href="#访客管理" class="headerlink" title="访客管理"></a>访客管理</h2><h3 id="邀请访客"><a href="#邀请访客" class="headerlink" title="邀请访客"></a>邀请访客</h3><h4 id="用户交互-1"><a href="#用户交互-1" class="headerlink" title="用户交互"></a>用户交互</h4><ol>
<li>监听 van-action-sheet 组件的 select 事件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- visitor_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-action-sheet</span> <span class="attr">bind:close</span>=<span class="string">&quot;closeHouseLayer&quot;</span> <span class="attr">bind:cancel</span>=<span class="string">&quot;closeHouseLayer&quot;</span> <span class="attr">bind:select</span>=<span class="string">&quot;selectHouse&quot;</span> <span class="attr">round</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123; houseLayerVisible &#125;&#125;&quot;</span> <span class="attr">actions</span>=<span class="string">&quot;&#123;&#123; houseList &#125;&#125;&quot;</span> <span class="attr">cancel-text</span>=<span class="string">&quot;取消&quot;</span> <span class="attr">title</span>=<span class="string">&quot;选择房屋信息&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在 selectHouse 回调方法中获取用户选择的房屋信息。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// visitor_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">selectHouse</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取房到的信息数据</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            <span class="attr">id</span>: houseId,</span><br><span class="line">            <span class="attr">name</span>: houseInfo</span><br><span class="line">        &#125; = ev.detail</span><br><span class="line">        <span class="comment">// 页面中渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseId,</span><br><span class="line">            houseInfo</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将用户选择的房屋信息渲染到页面中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- visitor_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">title</span>=<span class="string">&quot;房屋信息&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;houseInfo || &#x27;请选择房屋信息&#x27;&#125;&#125;&quot;</span> <span class="attr">value-class</span>=<span class="string">&quot;&#123;&#123;houseInfo &amp;&amp; &#x27;active-cell&#x27;&#125;&#125;&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">bind:click</span>=<span class="string">&quot;openHouseLayer&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>监听 van-datetime-picker 组件的 confirm 事件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- visitor_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-popup</span> <span class="attr">bind:close</span>=<span class="string">&quot;closeDateLayer&quot;</span> <span class="attr">round</span> <span class="attr">show</span>=<span class="string">&quot;&#123;&#123; dateLayerVisible &#125;&#125;&quot;</span> <span class="attr">position</span>=<span class="string">&quot;bottom&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-datetime-picker</span> <span class="attr">bind:confirm</span>=<span class="string">&quot;selectDate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; currentDate &#125;&#125;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;date&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-popup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在事件回调中获取用户选择的日期。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// visitor_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="comment">// 指定 van-datetime-picker 组件的起始日期</span></span><br><span class="line">        <span class="attr">currentDate</span>: <span class="built_in">Date</span>.now()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">selectDate</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取访客来访的时间</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            <span class="comment">// 隐藏时间弹层</span></span><br><span class="line">            <span class="attr">dateLayerVisible</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">visitDate</span>: wx.utils.formatDate(ev.detail)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>将用户选择的日期渲染到页面的 van-cell 组件中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- visitor_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title-width</span>=<span class="string">&quot;200rpx&quot;</span> <span class="attr">title</span>=<span class="string">&quot;访问日期&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;visitDate || &#x27;请选择访问日期&#x27;&#125;&#125;&quot;</span> <span class="attr">value-class</span>=<span class="string">&quot;&#123;&#123;visitDate &amp;&amp; &#x27;active-cell&#x27;&#125;&#125;&quot;</span> <span class="attr">bind:click</span>=<span class="string">&quot;openDateLayer&quot;</span> <span class="attr">is-link</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="房屋列表-2"><a href="#房屋列表-2" class="headerlink" title="房屋列表"></a>房屋列表</h4><p>通过调用接口获取自已账号下的房屋信息。</p>
<ul>
<li><p>接口路径：/house。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：无。</p>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42635315">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repair_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">houseList</span>: [],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取房屋列表</span></span><br><span class="line">        <span class="built_in">this</span>.getHouseList()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getHouseList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: houseList</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/house&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口返回的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取房屋列表失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 数据渲染</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            houseList</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>🤔 提示：这里只能查询到通过审核通过的房屋信息。</p>
<h4 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h4><ol>
<li>使用 <code>model:value</code> 分别获取访客姓名、访客性别、访客手机号 3 个数据。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- visitor_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">label</span>=<span class="string">&quot;姓名&quot;</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;name&#125;&#125;&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入访客真实姓名&quot;</span> /&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">van-radio-group</span> <span class="attr">direction</span>=<span class="string">&quot;horizontal&quot;</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;gender&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-radio</span> <span class="attr">icon-size</span>=<span class="string">&quot;36rpx&quot;</span> <span class="attr">checked-color</span>=<span class="string">&quot;#5591AF&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&#123;&#123;1&#125;&#125;&quot;</span>&gt;</span>男</span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-radio</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-radio</span> <span class="attr">icon-size</span>=<span class="string">&quot;36rpx&quot;</span> <span class="attr">checked-color</span>=<span class="string">&quot;#5591AF&quot;</span> <span class="attr">name</span>=<span class="string">&quot;&#123;&#123;0&#125;&#125;&quot;</span>&gt;</span>女</span><br><span class="line">    <span class="tag">&lt;/<span class="name">van-radio</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">van-radio-group</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">van-field</span> <span class="attr">label</span>=<span class="string">&quot;手机号&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">model:value</span>=<span class="string">&quot;&#123;&#123;mobile&#125;&#125;&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入访客联系电话号码&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>校验相关信息（这儿类似的代码前面写过多次，要求大家能读懂就可以）。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// visitor_pkg/pages/form/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">gender</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">mobile</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">verifyHouse</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> valid = <span class="built_in">this</span>.data.houseId !== <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请选择房屋信息!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 验证业主姓名（必须为汉字）</span></span><br><span class="line">    <span class="function"><span class="title">verifyName</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 正则表达式</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[\u4e00-\u9fa5]&#123;2,5&#125;$/</span></span><br><span class="line">        <span class="comment">// 验证业主姓名</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.name.trim())</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写真实中文姓名!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">verifyMobile</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 验证手机号</span></span><br><span class="line">        <span class="keyword">const</span> reg = <span class="regexp">/^[1][3-8][0-9]&#123;9&#125;$/</span></span><br><span class="line">        <span class="keyword">const</span> valid = reg.test(<span class="built_in">this</span>.data.mobile)</span><br><span class="line">        <span class="comment">// 验证结果提示</span></span><br><span class="line">        <span class="keyword">if</span> (!valid) wx.utils.toast(<span class="string">&#x27;请填写正确的手机号码!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 返回验证结果</span></span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="调用接口"><a href="#调用接口" class="headerlink" title="调用接口"></a>调用接口</h4><ol>
<li>监听用户【确认】按钮的点击事件。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- repair_pkg/pages/form/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;submitForm&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-confirm&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;button-text&quot;</span>&gt;</span>确认<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用添加访客信息的接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/visitor</code>。</p>
</li>
<li><p>请求方法: POST。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li><p>houseId 房屋id。</p>
</li>
<li><p>name 访客姓名。</p>
</li>
<li><p>gender 访客性别。</p>
</li>
<li><p>mobile 访客手机号。</p>
</li>
<li><p>visitDate 访客访问时间。</p>
</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400760">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">submitForm</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// #1 逐个验证表单的数据</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyHouse()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyName()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.verifyMobile()) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// #2 待提交的数据</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            houseId,</span><br><span class="line">            name,</span><br><span class="line">            gender,</span><br><span class="line">            mobile,</span><br><span class="line">            visitDate</span><br><span class="line">        &#125; = <span class="built_in">this</span>.data</span><br><span class="line">        <span class="comment">// #3 请求接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            data</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.post(<span class="string">&#x27;/visitor&#x27;</span>, &#123;</span><br><span class="line">            houseId,</span><br><span class="line">            name,</span><br><span class="line">            gender,</span><br><span class="line">            mobile,</span><br><span class="line">            visitDate</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// #4 检测接口调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;添加访客失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// #5 查看通行证</span></span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/visitor_pkg/pages/passport/index?id=&#x27;</span> + data.id,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>提交代码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前被修改的文件</span></span><br><span class="line">git status</span><br><span class="line"><span class="comment"># 暂存文件</span></span><br><span class="line">git add .</span><br><span class="line"><span class="comment"># 提交到本地</span></span><br><span class="line">git commit -m <span class="string">&#x27;feat(repair): 完成访客邀请的功能&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="访客记录"><a href="#访客记录" class="headerlink" title="访客记录"></a>访客记录</h3><ol>
<li>调用访客记录的接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/visitor</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 访客邀请 id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-41400761">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// visitor_pkg/pages/list/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取访客列表</span></span><br><span class="line">        <span class="built_in">this</span>.getVistorList()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getVistorList</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">rows</span>: visitorList</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/visitor&#x27;</span>)</span><br><span class="line">        <span class="comment">// 检测接口调用结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取访客列表失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 渲染访客列表</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            visitorList</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 点击访客列表的每一项跳转到详情</span></span><br><span class="line">    <span class="function"><span class="title">goPassport</span>(<span class="params">ev</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            id,</span><br><span class="line">            status</span><br><span class="line">        &#125; = ev.mark</span><br><span class="line">        <span class="keyword">if</span> (status === <span class="number">0</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;当前通行证已失效&#x27;</span>)</span><br><span class="line">        <span class="comment">// 查看通信证</span></span><br><span class="line">        wx.navigateTo(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/visitor_pkg/pages/passport/index?id=&#x27;</span> + ev.mark.id,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将获取到的数据渲染到模板当中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">authorization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;true&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">show-scrollbar</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">enhanced</span> <span class="attr">scroll-y</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;visitor&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;visitor-title&quot;</span>&gt;</span>我的访客<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;visitor-list&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">van-cell-group</span> <span class="attr">wx:for</span>=<span class="string">&quot;&#123;&#123;visitorList&#125;&#125;&quot;</span> <span class="attr">wx:key</span>=<span class="string">&quot;id&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">mark:id</span>=<span class="string">&quot;&#123;&#123;item.id&#125;&#125;&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;goPassport&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">size</span>=<span class="string">&quot;large&quot;</span> <span class="attr">title</span>=<span class="string">&quot;&#123;&#123;item.houseInfo&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag success&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 1&#125;&#125;&quot;</span>&gt;</span>生效中<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;tag cancel&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;item.status === 0&#125;&#125;&quot;</span>&gt;</span>已失效<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">van-cell</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot; 访客姓名&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.name&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;手机号码&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.mobile&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">&quot;访问日期&quot;</span> <span class="attr">border</span>=<span class="string">&quot;&#123;&#123;false&#125;&#125;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;item.visitDate&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">wx:else</span> <span class="attr">class</span>=<span class="string">&quot;blank&quot;</span>&gt;</span></span><br><span class="line">        您还没有访客记录，请点击</span><br><span class="line">        <span class="tag">&lt;<span class="name">navigator</span> <span class="attr">hover-class</span>=<span class="string">&quot;none&quot;</span> <span class="attr">class</span>=<span class="string">&quot;link&quot;</span> <span class="attr">url</span>=<span class="string">&quot;/visitor_pkg/pages/form/index&quot;</span>&gt;</span>添加<span class="tag">&lt;/<span class="name">navigator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">authorization</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="访客通知证"><a href="#访客通知证" class="headerlink" title="访客通知证"></a>访客通知证</h3><p>所谓的通行证是由后端生成的一个二维码，该二维码具有时效性（不超过 72 小时），本节的任务是调用接口获取通行证并展示给用户。</p>
<h4 id="数据渲染-1"><a href="#数据渲染-1" class="headerlink" title="数据渲染"></a>数据渲染</h4><ol>
<li>调用后端的接口。</li>
</ol>
<ul>
<li><p>接口路径：<code>/visitor/:id</code>。</p>
</li>
<li><p>请求方法: GET。</p>
</li>
<li><p>请求参数：</p>
<ul>
<li>id 访客邀请 id。</li>
</ul>
</li>
<li><p>Headers：</p>
<ul>
<li>Authorization。</li>
</ul>
</li>
<li><p>响应数据：<a target="_blank" rel="noopener" href="https://www.apifox.cn/apidoc/shared-8d66c345-7a9a-4844-9a5a-1201852f6faa/api-42635315">见文档</a>。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// visitor_pkg/pages/passport/index.js</span></span><br><span class="line">Page(&#123;</span><br><span class="line">    <span class="function"><span class="title">onLoad</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        id</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取通行证</span></span><br><span class="line">        <span class="built_in">this</span>.getPassport(id)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">getPassport</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!id) <span class="keyword">return</span></span><br><span class="line">        <span class="comment">// 请求数据接口</span></span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            code,</span><br><span class="line">            <span class="attr">data</span>: passport</span><br><span class="line">        &#125; = <span class="keyword">await</span> wx.http.get(<span class="string">&#x27;/visitor/&#x27;</span> + id)</span><br><span class="line">        <span class="comment">// 检测接口调用的结果</span></span><br><span class="line">        <span class="keyword">if</span> (code !== <span class="number">10000</span>) <span class="keyword">return</span> wx.utils.toast(<span class="string">&#x27;获取通行证失败!&#x27;</span>)</span><br><span class="line">        <span class="comment">// 渲染通行证</span></span><br><span class="line">        <span class="built_in">this</span>.setData(&#123;</span><br><span class="line">            ...passport</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将数据渲染到模板当中。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- visitor_pkg/pages/passport/index.wxml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;passport&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;countdown&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;validTime &gt; 0&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">van-count-down</span> <span class="attr">time</span>=<span class="string">&quot;&#123;&#123; validTime * 1000 &#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>通行证有效时间<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">block</span> <span class="attr">wx:else</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;van-count-down&quot;</span>&gt;</span>00:00:00<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>通行证已失效!<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">block</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;qrcode&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123;url&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;description&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;house&quot;</span>&gt;</span>&#123;&#123;houseInfo&#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;tips&quot;</span>&gt;</span>将此二维码分享给访客，访客扫码即可开门<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 通行证失效后将不再允许分享和保存二维码到本地 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;toolbar&quot;</span> <span class="attr">wx:if</span>=<span class="string">&quot;&#123;&#123;validTime &gt; 0&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button-share&quot;</span> <span class="attr">open-type</span>=<span class="string">&quot;share&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-share&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text&quot;</span>&gt;</span>分享给朋友<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button-save&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-save&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text&quot;</span>&gt;</span>保存到本地<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="分享给朋友"><a href="#分享给朋友" class="headerlink" title="分享给朋友"></a>分享给朋友</h4><p>小程序中提供了<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onShareAppMessage-Object-object">自定义分享</a>内容的方法，需要满足两个条件。</p>
<ul>
<li><p>用户点击 button 组件，且 open-type 的值设置为 share。</p>
</li>
<li><p>在页面中监听事件回调 onShareAppMessage。</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="title">onShareAppMessage</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;查看通行证&#x27;</span>,</span><br><span class="line">            <span class="attr">path</span>: <span class="string">&#x27;/visitor_pkg/pages/passport/index&#x27;</span>,</span><br><span class="line">            <span class="attr">imageUrl</span>: <span class="string">&#x27;https://enjoy-plus.oss-cn-beijing.aliyuncs.com/images/share_poster.png&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="保存通行码"><a href="#保存通行码" class="headerlink" title="保存通行码"></a>保存通行码</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.saveImageToPhotosAlbum.html">wx.saveImageToPhotosAlbum()</a>：保存图片到本地（不支持网络路径）。</p>
<p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.getImageInfo.html">wx.getImageInfo()</a>：可以把网络路径变为临时路径（注意需要在后台配置 download 域名）。</p>
<ol>
<li>绑定点击事件，<code>miniprogram/visitor_pkg/pages/passport/index.wxml</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;button-save&quot;</span> <span class="attr">bind:tap</span>=<span class="string">&quot;saveImage&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;enjoy-icon icon-save&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text&quot;</span>&gt;</span>保存到本地<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在事件回调中进行处理，<code>miniprogram/visitor_pkg/pages/passport/index.js</code>。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">saveImage</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取图片的临时路径</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        path</span><br><span class="line">    &#125; = <span class="keyword">await</span> wx.getImageInfo(&#123;</span><br><span class="line">        <span class="attr">src</span>: <span class="built_in">this</span>.data.url,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 将图片保存到本地相册</span></span><br><span class="line">    <span class="keyword">await</span> wx.saveImageToPhotosAlbum(&#123;</span><br><span class="line">        <span class="attr">filePath</span>: path,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/20/xcx-course02/" rel="prev" title="02_小程序进阶">
      <i class="fa fa-chevron-left"></i> 02_小程序进阶
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/03/06/xcx-course04/" rel="next" title="04_小程序品优购项目">
      04_小程序品优购项目 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%9B%AE%E6%A0%87"><span class="nav-number">1.</span> <span class="nav-text">项目目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87"><span class="nav-number">2.</span> <span class="nav-text">开发准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">项目介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE"><span class="nav-number">2.2.</span> <span class="nav-text">启动项目</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%89%E5%8F%96%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.1.</span> <span class="nav-text">拉取代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.2.</span> <span class="nav-text">运行代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%86%9F%E6%82%89%E7%8E%AF%E5%A2%83"><span class="nav-number">2.2.3.</span> <span class="nav-text">熟悉环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VSCode"><span class="nav-number">2.2.4.</span> <span class="nav-text">VSCode</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">工具方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%8D%E9%A6%88"><span class="nav-number">3.1.</span> <span class="nav-text">消息反馈</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%B0%81%E8%A3%85"><span class="nav-number">3.1.1.</span> <span class="nav-text">基础封装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%80%E9%83%A8%E5%8A%A0%E8%BD%BD"><span class="nav-number">3.1.2.</span> <span class="nav-text">局部加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8A%A0%E8%BD%BD"><span class="nav-number">3.1.3.</span> <span class="nav-text">全局加载</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="nav-number">3.2.</span> <span class="nav-text">网络请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-wechat-http"><span class="nav-number">3.2.1.</span> <span class="nav-text">安装 wechat-http</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%AC%E5%85%B1%E9%85%8D%E7%BD%AE"><span class="nav-number">3.2.2.</span> <span class="nav-text">公共配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8A%A0%E8%BD%BD-1"><span class="nav-number">3.2.3.</span> <span class="nav-text">全局加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">3.2.4.</span> <span class="nav-text">配置拦截器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AC%E5%91%8A%E7%AE%A1%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">公告管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AC%E5%91%8A%E5%88%97%E8%A1%A8"><span class="nav-number">4.1.</span> <span class="nav-text">公告列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="nav-number">4.1.1.</span> <span class="nav-text">接口调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93"><span class="nav-number">4.1.2.</span> <span class="nav-text">模板渲染</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AC%E5%91%8A%E8%AF%A6%E6%83%85"><span class="nav-number">4.2.</span> <span class="nav-text">公告详情</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">接口调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">模板渲染</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%8C%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86"><span class="nav-number">4.2.3.</span> <span class="nav-text">富文本处理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">用户管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E6%A3%80%E6%B5%8B"><span class="nav-number">5.1.</span> <span class="nav-text">登录检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="nav-number">5.2.</span> <span class="nav-text">用户登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%80%92%E8%AE%A1%E6%97%B6%E5%8A%9F%E8%83%BD"><span class="nav-number">5.2.1.</span> <span class="nav-text">倒计时功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="nav-number">5.2.2.</span> <span class="nav-text">获取验证码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E5%92%8C%E6%B3%A8%E5%86%8C"><span class="nav-number">5.2.3.</span> <span class="nav-text">登录和注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">5.2.4.</span> <span class="nav-text">请求拦截器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#refresh-token"><span class="nav-number">5.2.5.</span> <span class="nav-text">refresh_token</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E8%B5%84%E6%96%99"><span class="nav-number">5.3.</span> <span class="nav-text">个人资料</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%98%B5%E7%A7%B0"><span class="nav-number">5.3.1.</span> <span class="nav-text">用户昵称</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="nav-number">5.3.2.</span> <span class="nav-text">用户头像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%B5%84%E6%96%99"><span class="nav-number">5.3.3.</span> <span class="nav-text">获取资料</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%BF%E5%B1%8B%E7%AE%A1%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">房屋管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%88%BF%E5%B1%8B"><span class="nav-number">6.1.</span> <span class="nav-text">添加房屋</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%B0%E7%90%86%E5%AE%9A%E4%BD%8D"><span class="nav-number">6.1.1.</span> <span class="nav-text">地理定位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%85%BE%E8%AE%AF%E4%BD%8D%E7%BD%AE"><span class="nav-number">6.1.2.</span> <span class="nav-text">腾讯位置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E6%A5%BC%E6%A0%8B"><span class="nav-number">6.1.3.</span> <span class="nav-text">选择楼栋</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E6%88%BF%E9%97%B4"><span class="nav-number">6.1.4.</span> <span class="nav-text">选择房间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%88%BF%E5%B1%8B-1"><span class="nav-number">6.1.5.</span> <span class="nav-text">添加房屋</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E5%B1%8B%E5%88%97%E8%A1%A8"><span class="nav-number">6.2.</span> <span class="nav-text">房屋列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%88%BF%E5%B1%8B"><span class="nav-number">6.3.</span> <span class="nav-text">删除房屋</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%BF%E5%B1%8B%E8%AF%A6%E6%83%85"><span class="nav-number">6.4.</span> <span class="nav-text">房屋详情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E6%88%BF%E5%B1%8B"><span class="nav-number">6.5.</span> <span class="nav-text">编辑房屋</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%A5%E4%BF%AE%E7%AE%A1%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">报修管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E7%BA%BF%E6%8A%A5%E4%BF%AE"><span class="nav-number">7.1.</span> <span class="nav-text">在线报修</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92"><span class="nav-number">7.1.1.</span> <span class="nav-text">用户交互</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%BF%E5%B1%8B%E5%88%97%E8%A1%A8-1"><span class="nav-number">7.1.2.</span> <span class="nav-text">房屋列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%B4%E4%BF%AE%E9%A1%B9%E7%9B%AE"><span class="nav-number">7.1.3.</span> <span class="nav-text">维修项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="nav-number">7.1.4.</span> <span class="nav-text">上传图片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4%E8%A1%A8%E5%8D%95"><span class="nav-number">7.1.5.</span> <span class="nav-text">提交表单</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E4%BF%AE%E5%88%97%E8%A1%A8"><span class="nav-number">7.2.</span> <span class="nav-text">报修列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E4%BF%AE%E8%AF%A6%E6%83%85"><span class="nav-number">7.3.</span> <span class="nav-text">报修详情</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93"><span class="nav-number">7.3.1.</span> <span class="nav-text">数据渲染</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8A%E9%97%A8%E8%B7%AF%E7%BA%BF"><span class="nav-number">7.3.2.</span> <span class="nav-text">上门路线</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E6%8A%A5%E4%BF%AE"><span class="nav-number">7.4.</span> <span class="nav-text">取消报修</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E4%BF%A1%E6%81%AF"><span class="nav-number">7.5.</span> <span class="nav-text">修改信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E5%AE%A2%E7%AE%A1%E7%90%86"><span class="nav-number">8.</span> <span class="nav-text">访客管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%82%80%E8%AF%B7%E8%AE%BF%E5%AE%A2"><span class="nav-number">8.1.</span> <span class="nav-text">邀请访客</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92-1"><span class="nav-number">8.1.1.</span> <span class="nav-text">用户交互</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%88%BF%E5%B1%8B%E5%88%97%E8%A1%A8-2"><span class="nav-number">8.1.2.</span> <span class="nav-text">房屋列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81"><span class="nav-number">8.1.3.</span> <span class="nav-text">表单验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%8E%A5%E5%8F%A3"><span class="nav-number">8.1.4.</span> <span class="nav-text">调用接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E5%AE%A2%E8%AE%B0%E5%BD%95"><span class="nav-number">8.2.</span> <span class="nav-text">访客记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E5%AE%A2%E9%80%9A%E7%9F%A5%E8%AF%81"><span class="nav-number">8.3.</span> <span class="nav-text">访客通知证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93-1"><span class="nav-number">8.3.1.</span> <span class="nav-text">数据渲染</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E4%BA%AB%E7%BB%99%E6%9C%8B%E5%8F%8B"><span class="nav-number">8.3.2.</span> <span class="nav-text">分享给朋友</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98%E9%80%9A%E8%A1%8C%E7%A0%81"><span class="nav-number">8.3.3.</span> <span class="nav-text">保存通行码</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ifer"
      src="/images/49337922.png">
  <p class="site-author-name" itemprop="name">Ifer</p>
  <div class="site-description" itemprop="description">React 全家桶 <span style='position:relative;top:-2px;'>✍</span></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://www.bilibili.com/video/BV1iW4y1k7Ci?spm_id_from=333.337.search-card.all.click" title="😚 → https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1iW4y1k7Ci?spm_id_from&#x3D;333.337.search-card.all.click" rel="noopener" target="_blank"><i class="a fa-fw"></i>😚</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/weixiantx" title="😙 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;weixiantx" rel="noopener" target="_blank"><i class="a fa-fw"></i>😙</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ifer</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
