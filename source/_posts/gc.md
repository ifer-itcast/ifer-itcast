---
title: GC
date: 2021-02-04 07:33:29
tags: [GC, 垃圾回收]
categories: 面试
---

了解下垃圾回收吧

<!-- more -->

## 为什么需要垃圾回收

JS 中无论声明变量、定义函数，实际上来说都需要在内存当中开辟一个空间去存储，如果说只有存储没有销毁（回收）的过程，内存肯定支撑不了，当前程序/甚至其他程序可能直接崩溃，所以就需要垃圾回收！

## JS 怎么做垃圾回收的

JS 是自动垃圾回收的机制，好处是无需程序员手动开辟和释放，省事，但同时也意味着程序员无法手动干预，JS 也没有暴漏任何关于内存的 API。

## 常见的垃圾回收方式

### 引用计数

一个对象每被引用一次都会加 1，什么时候这个对象的引用变成 0 了，就会被垃圾回收器回收

```js
// 把这个对象（O）的引用给了 obj1 这个变量
var obj1 = { name: 'ifer' }; // +1
var obj2 = obj1; // 这个对象 O 又被引用了一次，+1

obj1 = null; // 这个 O 的引用少了一次，-1
obj2 = null; // 这个 O 的引用又少了一次，-1

// 此时 O 的引用还有多少次？还有 0 次，被垃圾回收器回收
```

引用计数的问题？解决不了循环引用

```js
var obj1 = { name: 'ifer' }; // 这个对象 O1 +1
var obj2 = { age: 18 }; // 这个对象 O2 被引用了 1次，+1

obj1.xxx = obj2; // 这个对象 O2 又被引用了 1次，+1
obj2.xxx = obj1; // 这个对象 O1 又被引用了 1 次， +1

obj1 = null; // 这个对象 O1，-1
obj2 = null; // 这个对象 O2，-1
```

### 标记清除

1\. 给所有的变量加上标记

2\. 把所有可达的变量（可达值，通过某种方式可以被访问的变量）的标记去掉

3\. 剩下的所有带标记的变量就是待删除的了（就是要被GC）

4\. GC

```js
// #1 标记进入环境，加上标记
var obj1 = { name: 'ifer' };
var obj2 = { age: 18 };
var obj3 = { sex: 'man' };

obj1.xxx = obj2;
obj2.xxx = obj1;

obj1 = null;
obj2 = null;
// #2 代码执行完毕，把 obj3 的标记去掉（可达），obj1、obj2 由于不可达，标记还在

// #3 清除带标记的
```

<font size=2 color=#ccc>注意一般垃圾回收，回收的是未被标记的！但 JS 高级程序当中说的确实是回收带标记的变量，参考这个[问题](https://www.zhihu.com/question/49016939/answer/129995652)</font>


## JavaScript 内存泄漏

[参考阮一峰JavaScript 内存泄漏教程](http://www.ruanyifeng.com/blog/2017/04/memory-leak.html)
